<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <title>Ghasiq – إدارة المستخدمين</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet" />

    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --accent: #22c55e;

            --bg-main: #020617;
            --bg-elevated: rgba(15, 23, 42, 0.94);
            --bg-card: rgba(15, 23, 42, 0.98);
            --border-subtle: rgba(148, 163, 184, 0.35);

            --text-main: #e5e7eb;
            --text-muted: #9ca3af;
            --shadow-strong: 0 20px 45px rgba(0, 0, 0, 0.8);
        }

        body.light {
            --bg-main: #f5f7fb;
            --bg-elevated: #ffffff;
            --bg-card: #ffffff;
            --border-subtle: rgba(148, 163, 184, 0.5);
            --text-main: #0f172a;
            --text-muted: #6b7280;
            --shadow-strong: 0 20px 45px rgba(15, 23, 42, 0.15);
        }

        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family:"Cairo",system-ui;
            background:
                radial-gradient(circle at top left, rgba(37, 99, 235, 0.35), transparent 55%),
                radial-gradient(circle at bottom right, rgba(56, 189, 248, 0.28), transparent 55%),
                linear-gradient(135deg, #00020b, var(--bg-main) 45%, #00010a);
            color:var(--text-main);
            min-height:100vh;
        }

        body.light {
            background:
                radial-gradient(circle at top left, rgba(191, 219, 254, 0.7), transparent 55%),
                radial-gradient(circle at bottom right, rgba(219, 234, 254, 0.7), transparent 55%),
                linear-gradient(135deg, #e5edff, #f9fafb 50%, #eff6ff);
        }

        a { text-decoration:none; color:inherit; }

        .page {
            max-width:1140px;
            margin:0 auto;
            padding:20px 18px 40px;
        }

        .navbar {
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:14px 18px;
            border-radius:16px;
            background:var(--bg-elevated);
            box-shadow:
                0 16px 35px rgba(0,0,0,0.75),
                0 0 0 1px rgba(148,163,184,0.3);
            margin-bottom:26px;
            backdrop-filter:blur(14px);
        }

        .navbar-left {
            display:flex;
            align-items:center;
            gap:14px;
        }

        .logo {
            height:46px;
            cursor:pointer;
        }

        .nav-links {
            display:flex;
            gap:16px;
            font-size:14px;
            color:var(--text-muted);
        }

        .nav-links a {
            position:relative;
            padding-bottom:4px;
        }

        .nav-links a::after {
            content:"";
            position:absolute;
            right:0;
            bottom:0;
            width:0;
            height:2px;
            border-radius:999px;
            background:linear-gradient(90deg,var(--primary-light),var(--primary));
            transition:width .18s ease;
        }

        .nav-links a:hover::after,
        .nav-links a.active::after {
            width:100%;
        }

        .nav-links a.active {
            color:#e5e7eb;
            font-weight:600;
        }

        .nav-actions {
            display:flex;
            align-items:center;
            gap:8px;
        }

        .btn-toggle-theme,
        .btn-logout {
            border-radius:999px;
            border:1px solid var(--border-subtle);
            background:transparent;
            color:var(--text-main);
            padding:6px 12px;
            font-size:13px;
            cursor:pointer;
            display:flex;
            align-items:center;
            gap:6px;
        }

        .btn-logout {
            border-color:#f97373;
            color:#fecaca;
        }

        body.light .btn-logout {
            color:#b91c1c;
        }

        .user-chip {
            font-size:11px;
            padding:4px 10px;
            border-radius:999px;
            border:1px solid rgba(148,163,184,0.7);
            color:var(--text-muted);
        }

        .layout {
            display:grid;
            grid-template-columns:minmax(0, 0.9fr) minmax(0, 1.1fr);
            gap:20px;
        }

        @media(max-width:900px){
            .layout { grid-template-columns:1fr; }
        }

        .card {
            border-radius:20px;
            background:var(--bg-elevated);
            border:1px solid var(--border-subtle);
            box-shadow:var(--shadow-strong);
            padding:18px 16px 18px;
        }

        .card-title {
            font-size:17px;
            margin-bottom:4px;
        }

        .card-sub {
            font-size:12px;
            color:var(--text-muted);
            margin-bottom:12px;
        }

        .input-group {
            margin-bottom:10px;
        }

        .input-group label {
            display:block;
            margin-bottom:4px;
            font-size:13px;
        }

        .input-group input,
        .input-group select {
            width:100%;
            padding:8px 10px;
            border-radius:10px;
            border:1px solid var(--border-subtle);
            background:rgba(15,23,42,0.9);
            color:var(--text-main);
            font-size:13px;
            outline:none;
        }

        body.light .input-group input,
        body.light .input-group select {
            background:#ffffff;
            color:#0f172a;
        }

        .input-inline {
            display:flex;
            align-items:center;
            gap:8px;
            font-size:13px;
            margin-top:4px;
        }

        .input-inline input[type="checkbox"] {
            width:auto;
        }

        .btn-primary {
            border-radius:999px;
            padding:9px 16px;
            border:none;
            cursor:pointer;
            background:linear-gradient(135deg,var(--primary),var(--primary-light));
            color:white;
            font-size:13px;
            margin-top:6px;
        }

        .btn-secondary {
            border-radius:999px;
            padding:7px 12px;
            border:1px solid var(--border-subtle);
            cursor:pointer;
            background:transparent;
            color:var(--text-muted);
            font-size:12px;
            margin-top:6px;
            margin-right:8px;
        }

        .error-box,
        .success-box {
            margin-bottom:8px;
            padding:7px 9px;
            border-radius:10px;
            font-size:12px;
            display:none;
        }

        .error-box {
            background:rgba(239,68,68,0.1);
            border:1px solid rgba(248,113,113,0.7);
            color:#fecaca;
        }

        .success-box {
            background:rgba(22,163,74,0.12);
            border:1px solid rgba(34,197,94,0.8);
            color:#bbf7d0;
        }

        body.light .error-box {
            background:#fee2e2;
            color:#b91c1c;
            border-color:#fecaca;
        }

        body.light .success-box {
            background:#dcfce7;
            color:#166534;
            border-color:#22c55e;
        }

        table {
            width:100%;
            border-collapse:collapse;
            font-size:13px;
        }

        th, td {
            padding:8px 6px;
            border-bottom:1px dashed rgba(148,163,184,0.35);
            text-align:right;
        }

        th {
            color:var(--text-muted);
            font-weight:500;
        }

        .badge-admin {
            padding:2px 8px;
            border-radius:999px;
            font-size:11px;
            background:rgba(37,99,235,0.15);
            border:1px solid rgba(59,130,246,0.7);
        }

        .badge-user {
            padding:2px 8px;
            border-radius:999px;
            font-size:11px;
            background:rgba(15,23,42,0.9);
            border:1px solid rgba(148,163,184,0.6);
        }

        .btn-small {
            padding:4px 8px;
            font-size:11px;
            border-radius:999px;
            border:1px solid rgba(148,163,184,0.8);
            background:transparent;
            color:#e5e7eb;
            cursor:pointer;
            margin-left:4px;
        }

        .btn-small.danger {
            border-color:rgba(248,113,113,0.9);
            color:#fecaca;
        }

        body.light .btn-small {
            color:#0f172a;
        }

        body.light .btn-small.danger {
            color:#b91c1c;
        }

        tr.editing-row {
            background:rgba(37,99,235,0.15);
        }

        .footer {
            margin-top:24px;
            text-align:center;
            font-size:12px;
            color:var(--text-muted);
        }

        .footer span { color:var(--primary-light); }
    </style>
</head>
<body class="dark">

<!-- حماية الصفحة: لازم أدمن -->
<script>
    (function guardAdmin() {
        const u = JSON.parse(localStorage.getItem("ghasiq_user") || "null");
        if (!u || !u.login || !u.isAdmin) {
            window.location.href = "login.html";
            return;
        }
        window.__gh_user = u;
    })();
</script>

<div class="page">

    <header class="navbar">
        <div class="navbar-left">
            <a href="index.html">
                <img src="logo.png" alt="GHASIQ Logo" class="logo" />
            </a>
         <nav class="nav-links">
    <a href="index.html#about">عن Ghasiq</a>
    <a href="services.html">الخدمات</a>
    <a href="call-system.html">نظام الاتصال</a>
    <a href="notifications.html">الإشعارات</a>
    <a href="admin-users.html" id="navAdminLink" style="display:none;">إدارة المستخدمين</a>
</nav>


        </div>

        <div class="nav-actions">
            <span id="userChip" class="user-chip"></span>

            <button class="btn-toggle-theme" id="themeToggle" type="button">
                <span id="themeLabel">Dark</span>
                <span id="themeIcon">☾</span>
            </button>

            <button class="btn-logout" type="button" onclick="logout()">تسجيل الخروج</button>
        </div>
    </header>

    <section class="layout">
        <!-- إنشاء / تعديل مستخدم -->
        <aside class="card">
            <h2 class="card-title" id="formTitle">إنشاء مستخدم جديد</h2>
            <p class="card-sub" id="formSub">
                أدخل بيانات المستخدم. المستخدم الأدمن يستطيع الدخول لهذه الصفحة وإنشاء مستخدمين آخرين.
            </p>

            <div id="msgError" class="error-box"></div>
            <div id="msgSuccess" class="success-box"></div>

            <div class="input-group">
                <label for="newUsername">اسم المستخدم</label>
                <input id="newUsername" type="text" autocomplete="off" />
            </div>

            <div class="input-group">
                <label for="newPassword">كلمة المرور</label>
                <input id="newPassword" type="password" autocomplete="off" />
            </div>

            <div class="input-group">
                <label for="newPassword2">تأكيد كلمة المرور</label>
                <input id="newPassword2" type="password" autocomplete="off" />
            </div>

            <div class="input-group">
                <label for="newRole">المنصب / الدور (يظهر في نظام الاتصال)</label>
                <input id="newRole" type="text" placeholder="مثال: IT Head أو HR Head" />
            </div>

            <div class="input-inline">
                <input id="newIsAdmin" type="checkbox" />
                <label for="newIsAdmin">هذا المستخدم أدمن (يمكنه إدارة المستخدمين)</label>
            </div>

            <div>
                <button class="btn-primary" type="button" onclick="saveUser()">حفظ المستخدم</button>
                <button class="btn-secondary" type="button" id="btnCancelEdit" style="display:none;" onclick="cancelEdit()">إلغاء التعديل</button>
            </div>
        </aside>

        <!-- قائمة المستخدمين -->
        <article class="card">
            <h2 class="card-title">قائمة المستخدمين</h2>
            <p class="card-sub">
                البيانات تُدار من خلال الـ API. يمكنك تعديل أو حذف المستخدمين، مع عدم السماح بحذف أو إلغاء آخر أدمن.
            </p>

            <div style="overflow-x:auto;">
                <table>
                    <thead>
                    <tr>
                        <th>اسم المستخدم</th>
                        <th>الدور</th>
                        <th>النوع</th>
                        <th>إجراءات</th>
                    </tr>
                    </thead>
                    <tbody id="usersTableBody">
                    <!-- rows -->
                    </tbody>
                </table>
            </div>
        </article>
    </section>

    <footer class="footer">
        © <span>Ghasiq</span> Logistical Support & Operations — لوحة إدارة المستخدمين.
    </footer>
</div>

<script>
    // Theme
    const bodyEl = document.body;
    const themeToggle = document.getElementById("themeToggle");
    const themeLabel = document.getElementById("themeLabel");
    const themeIcon = document.getElementById("themeIcon");

    function applyTheme(mode) {
        if (mode === "light") {
            bodyEl.classList.add("light");
            bodyEl.classList.remove("dark");
            themeLabel.textContent = "Light";
            themeIcon.textContent = "☀";
        } else {
            bodyEl.classList.add("dark");
            bodyEl.classList.remove("light");
            themeLabel.textContent = "Dark";
            themeIcon.textContent = "☾";
        }
        localStorage.setItem("ghasiq_theme", mode);
    }

    function initTheme() {
        const saved = localStorage.getItem("ghasiq_theme");
        applyTheme(saved === "light" ? "light" : "dark");
    }

    themeToggle.addEventListener("click", () => {
        const isLight = bodyEl.classList.contains("light");
        applyTheme(isLight ? "dark" : "light");
    });

    initTheme();

    // User chip
    (function showUser() {
        const chip = document.getElementById("userChip");
        const user = window.__gh_user;
        if (!user) return;
        chip.textContent = `${user.username} (${user.role})`;
    })();

    function logout() {
        localStorage.removeItem("ghasiq_user");
        window.location.href = "login.html";
    }

    // =========================
    //  API CONFIG + STATE
    // =========================
    const API_URL = "https://filesregsiteration.sstli.com/users.php";

    let usersCache = [];    // Users from API
    let editingUserId = null;

    function showMessage(type, text) {
        const err = document.getElementById("msgError");
        const ok = document.getElementById("msgSuccess");
        err.style.display = "none";
        ok.style.display = "none";

        if (type === "error") {
            err.textContent = text;
            err.style.display = "block";
        } else if (type === "success") {
            ok.textContent = text;
            ok.style.display = "block";
        }
    }

    // =========================
    //  FETCH + RENDER
    // =========================
    async function fetchUsers() {
        try {
            const res = await fetch(API_URL, {
                method: "GET"
            });
            const json = await res.json();

            if (!json.success) {
                throw new Error(json.message || "تعذر جلب المستخدمين من السيرفر.");
            }

            usersCache = (json.data && json.data.users) || [];
            renderUsers();
        } catch (err) {
            console.error(err);
            showMessage("error", err.message || "تعذر جلب المستخدمين من السيرفر.");
        }
    }

    function renderUsers() {
        const tbody = document.getElementById("usersTableBody");
        tbody.innerHTML = "";

        usersCache.forEach((u) => {
            const tr = document.createElement("tr");
            if (editingUserId === u.user_id) {
                tr.classList.add("editing-row");
            }

            const tdUsername = document.createElement("td");
            tdUsername.textContent = u.username;

            const tdRole = document.createElement("td");
            tdRole.textContent = u.role || "-";

            const tdType = document.createElement("td");
            const span = document.createElement("span");
            span.className = u.is_admin ? "badge-admin" : "badge-user";
            span.textContent = u.is_admin ? "أدمن" : "موظف";
            tdType.appendChild(span);

            const tdActions = document.createElement("td");
            const btnEdit = document.createElement("button");
            btnEdit.className = "btn-small";
            btnEdit.textContent = "تعديل";
            btnEdit.onclick = function () { startEditUser(u.user_id); };

            const btnDel = document.createElement("button");
            btnDel.className = "btn-small danger";
            btnDel.textContent = "حذف";
            btnDel.onclick = function () { deleteUser(u.user_id); };

            tdActions.appendChild(btnEdit);
            tdActions.appendChild(btnDel);

            tr.appendChild(tdUsername);
            tr.appendChild(tdRole);
            tr.appendChild(tdType);
            tr.appendChild(tdActions);

            tbody.appendChild(tr);
        });
    }

    // =========================
    //  FORM HELPERS
    // =========================
    function clearForm() {
        document.getElementById("newUsername").value = "";
        document.getElementById("newPassword").value = "";
        document.getElementById("newPassword2").value = "";
        document.getElementById("newRole").value = "";
        document.getElementById("newIsAdmin").checked = false;
    }

    function setFormModeCreate() {
        editingUserId = null;
        document.getElementById("formTitle").textContent = "إنشاء مستخدم جديد";
        document.getElementById("formSub").textContent =
            "أدخل بيانات المستخدم. المستخدم الأدمن يستطيع الدخول لهذه الصفحة وإنشاء مستخدمين آخرين.";
        document.getElementById("btnCancelEdit").style.display = "none";
        clearForm();
        renderUsers();
    }

    function startEditUser(userId) {
        const u = usersCache.find(x => x.user_id === userId);
        if (!u) return;

        editingUserId = userId;
        document.getElementById("formTitle").textContent = "تعديل مستخدم";
        document.getElementById("formSub").textContent =
            "يمكنك تعديل بيانات المستخدم أو كلمة المرور أو صلاحية الأدمن.";
        document.getElementById("btnCancelEdit").style.display = "inline-flex";

        document.getElementById("newUsername").value = u.username;
        document.getElementById("newPassword").value = "";
        document.getElementById("newPassword2").value = "";
        document.getElementById("newRole").value = u.role || "";
        document.getElementById("newIsAdmin").checked = !!u.is_admin;

        showMessage(null, "");
        renderUsers();
    }

    function cancelEdit() {
        setFormModeCreate();
        showMessage(null, "");
    }

    // =========================
    //  CREATE / UPDATE
    // =========================
    async function saveUser() {
        const username = document.getElementById("newUsername").value.trim();
        const password = document.getElementById("newPassword").value;
        const password2 = document.getElementById("newPassword2").value;
        const role = document.getElementById("newRole").value.trim();
        const isAdmin = document.getElementById("newIsAdmin").checked;
        const currentUser = window.__gh_user;

        if (!username) {
            showMessage("error", "يرجى إدخال اسم المستخدم.");
            return;
        }

        // تأكد من uniqueness اسم المستخدم
        const lower = username.toLowerCase();
        const duplicate = usersCache.find(
            (u) => (u.username || "").toLowerCase() === lower && u.user_id !== editingUserId
        );
        if (duplicate) {
            showMessage("error", "اسم المستخدم مستخدم بالفعل.");
            return;
        }

        // تعديل
        if (editingUserId !== null) {
            const u = usersCache.find(x => x.user_id === editingUserId);
            if (!u) {
                showMessage("error", "المستخدم المطلوب للتعديل غير موجود.");
                return;
            }

            const adminsCount = usersCache.filter(x => x.is_admin).length;
            const willBeAdmin = isAdmin;
            if (u.is_admin && !willBeAdmin && adminsCount <= 1) {
                showMessage("error", "لا يمكن إزالة صلاحية الأدمن من آخر مستخدم أدمن.");
                return;
            }

            const payload = {
                id: u.user_id,
                username: username,
                role: role || u.role || (willBeAdmin ? "Administrator" : "Employee"),
                is_admin: willBeAdmin
            };

            if (password || password2) {
                if (!password || !password2) {
                    showMessage("error", "أدخل كلمة المرور وتأكيدها معًا أو اتركهما فارغين.");
                    return;
                }
                if (password !== password2) {
                    showMessage("error", "تأكيد كلمة المرور غير مطابق.");
                    return;
                }
                payload.password = password;
            }

            try {
                const res = await fetch(API_URL, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                const json = await res.json();
                if (!json.success) {
                    throw new Error(json.message || "فشل تحديث المستخدم.");
                }

                // لو عدّل نفسه، حدّث بيانات localStorage
                if (currentUser && currentUser.username.toLowerCase() === u.username.toLowerCase()) {
                    const updatedUser = {
                        username: payload.username,
                        role: payload.role,
                        login: true,
                        isAdmin: !!payload.is_admin
                    };
                    localStorage.setItem("ghasiq_user", JSON.stringify(updatedUser));
                    window.__gh_user = updatedUser;
                    const chip = document.getElementById("userChip");
                    chip.textContent = `${updatedUser.username} (${updatedUser.role})`;
                }

                await fetchUsers();
                showMessage("success", "تم تحديث بيانات المستخدم.");
                setFormModeCreate();
            } catch (err) {
                console.error(err);
                showMessage("error", err.message || "حدث خطأ أثناء التعديل.");
            }

            return;
        }

        // إنشاء جديد
        if (!password || !password2) {
            showMessage("error", "يرجى إدخال كلمة المرور وتأكيدها.");
            return;
        }
        if (password !== password2) {
            showMessage("error", "تأكيد كلمة المرور غير مطابق.");
            return;
        }

        const newPayload = {
            username: username,
            password: password,
            role: role || (isAdmin ? "Administrator" : "Employee"),
            is_admin: isAdmin
        };

        try {
            const res = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(newPayload)
            });
            const json = await res.json();
            if (!json.success) {
                throw new Error(json.message || "فشل إنشاء المستخدم.");
            }

            clearForm();
            await fetchUsers();
            showMessage("success", "تم إنشاء المستخدم بنجاح.");
        } catch (err) {
            console.error(err);
            showMessage("error", err.message || "حدث خطأ أثناء إنشاء المستخدم.");
        }
    }

    // =========================
    //  DELETE
    // =========================
    async function deleteUser(userId) {
        const currentUser = window.__gh_user;
        const userToDelete = usersCache.find(u => u.user_id === userId);
        if (!userToDelete) return;

        const adminsCount = usersCache.filter(u => u.is_admin).length;
        if (userToDelete.is_admin && adminsCount <= 1) {
            showMessage("error", "لا يمكن حذف آخر مستخدم أدمن.");
            return;
        }

        if (currentUser && currentUser.username.toLowerCase() === userToDelete.username.toLowerCase()) {
            if (!confirm("أنت على وشك حذف المستخدم الحالي. سيتم تسجيل خروجك بعد الحذف. هل أنت متأكد؟")) return;
        }

        try {
            const res = await fetch(API_URL + "?id=" + encodeURIComponent(userId), {
                method: "DELETE"
            });
            const json = await res.json();
            if (!json.success) {
                throw new Error(json.message || "فشل حذف المستخدم.");
            }

            // إزالة من الكاش
            usersCache = usersCache.filter(u => u.user_id !== userId);

            if (editingUserId === userId) {
                setFormModeCreate();
            }

            renderUsers();
            showMessage("success", "تم حذف المستخدم.");

            if (currentUser && currentUser.username.toLowerCase() === userToDelete.username.toLowerCase()) {
                logout();
            }
        } catch (err) {
            console.error(err);
            showMessage("error", err.message || "حدث خطأ أثناء حذف المستخدم.");
        }
    }

    // init
    fetchUsers();
</script>
<script>
(function handleAdminNav() {
    const adminLink = document.getElementById("navAdminLink");
    const userChip  = document.getElementById("userChip");

    let u = null;
    try {
        u = JSON.parse(localStorage.getItem("ghasiq_user") || "null");
    } catch { u = null; }

    // تحديث الشيب اللي فوق باسم اليوزر (لو موجود)
    if (userChip && u && u.username) {
        const role = u.role || (u.isAdmin || u.is_admin ? "admin" : "user");
        userChip.textContent = `${u.username} (${role})`;
    }

    if (!adminLink) return;

    // لو أدمن → أظهر اللينك
    if (u && u.login && (u.isAdmin || u.is_admin == 1 || u.role === "admin")) {
        adminLink.style.display = "inline-flex";
    } else {
        adminLink.style.display = "none";
    }
})();
</script>


</body>
</html>
