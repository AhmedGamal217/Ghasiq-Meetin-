<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <title>Ghasiq - نظام الإشعارات الداخلية</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet" />

    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --accent: #22c55e;

            --bg-main: #020617;
            --bg-elevated: rgba(15, 23, 42, 0.94);
            --bg-card: rgba(15, 23, 42, 0.98);
            --border-subtle: rgba(148, 163, 184, 0.35);

            --text-main: #e5e7eb;
            --text-muted: #9ca3af;
            --shadow-strong: 0 20px 45px rgba(0, 0, 0, 0.8);
        }

        body.light {
            --bg-main: #f5f7fb;
            --bg-elevated: #ffffff;
            --bg-card: #ffffff;
            --border-subtle: rgba(148, 163, 184, 0.5);
            --text-main: #0f172a;
            --text-muted: #6b7280;
            --shadow-strong: 0 20px 45px rgba(15, 23, 42, 0.15);
        }

        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family:"Cairo",system-ui;
            background:
                radial-gradient(circle at top left, rgba(37, 99, 235, 0.35), transparent 55%),
                radial-gradient(circle at bottom right, rgba(56, 189, 248, 0.28), transparent 55%),
                linear-gradient(135deg, #00020b, var(--bg-main) 45%, #00010a);
            color:var(--text-main);
            min-height:100vh;
        }

        body.light {
            background:
                radial-gradient(circle at top left, rgba(191, 219, 254, 0.7), transparent 55%),
                radial-gradient(circle at bottom right, rgba(219, 234, 254, 0.7), transparent 55%),
                linear-gradient(135deg, #e5edff, #f9fafb 50%, #eff6ff);
        }

        a { text-decoration:none; color:inherit; }

        .page {
            max-width:1140px;
            margin:0 auto;
            padding:20px 18px 40px;
        }

        /* NAVBAR */
        .navbar {
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:14px 18px;
            border-radius:16px;
            background:var(--bg-elevated);
            box-shadow:
                0 16px 35px rgba(0,0,0,0.75),
                0 0 0 1px rgba(148,163,184,0.3);
            margin-bottom:26px;
            backdrop-filter:blur(14px);
        }

        .navbar-left {
            display:flex;
            align-items:center;
            gap:14px;
        }

        .logo {
            height:46px;
            cursor:pointer;
        }

        .nav-links {
            display:flex;
            gap:16px;
            font-size:14px;
            color:var(--text-muted);
        }

        .nav-links a {
            position:relative;
            padding-bottom:4px;
            display:inline-flex;
            align-items:center;
            gap:4px;
        }

        .nav-links a::after {
            content:"";
            position:absolute;
            right:0;
            bottom:0;
            width:0;
            height:2px;
            border-radius:999px;
            background:linear-gradient(90deg,var(--primary-light),var(--primary));
            transition:width .18s ease;
        }

        .nav-links a:hover::after {
            width:100%;
        }

        .nav-links a.active {
            color:#e5e7eb;
            font-weight:600;
        }

        .nav-links a.active::after {
            width:100%;
        }

        .nav-actions {
            display:flex;
            align-items:center;
            gap:8px;
        }

        .btn-toggle-theme,
        .btn-logout,
        .btn-sm-outline {
            border-radius:999px;
            padding:6px 12px;
            font-size:12px;
            cursor:pointer;
            border:1px solid var(--border-subtle);
            background:rgba(15,23,42,0.85);
            color:#e5e7eb;
        }

        body.light .btn-toggle-theme,
        body.light .btn-logout,
        body.light .btn-sm-outline {
            background:#ffffff;
            color:#0f172a;
        }

        .btn-sm-outline {
            border-color:var(--primary-light);
            color:#dbeafe;
        }

        body.light .btn-sm-outline {
            color:#1d4ed8;
        }

        .btn-logout {
            border-color:#f97373;
            color:#fecaca;
        }

        body.light .btn-logout {
            color:#b91c1c;
        }

        .user-chip {
            font-size:11px;
            padding:4px 10px;
            border-radius:999px;
            border:1px solid rgba(148,163,184,0.7);
            color:var(--text-muted);
        }

        .badge {
            display:inline-flex;
            align-items:center;
            justify-content:center;
            min-width:20px;
            height:20px;
            border-radius:999px;
            font-size:11px;
            padding:0 6px;
            background:#ef4444;
            color:#fef2f2;
        }

        /* LAYOUT */
        .layout {
            display:grid;
            grid-template-columns:minmax(0, 1.2fr) minmax(0, 0.9fr);
            gap:18px;
        }

        @media(max-width:900px){
            .layout {
                grid-template-columns:1fr;
            }
        }

        .card {
            border-radius:20px;
            background:var(--bg-elevated);
            border:1px solid var(--border-subtle);
            box-shadow:var(--shadow-strong);
            padding:18px 16px 18px;
        }

        .card-header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:10px;
        }

        .card-title {
            font-size:17px;
        }

        .card-sub {
            font-size:12px;
            color:var(--text-muted);
        }

        .notifications-list {
            margin-top:8px;
            max-height:520px;
            overflow-y:auto;
            padding-right:4px;
        }

        .notif-item {
            display:flex;
            flex-direction:column;
            gap:3px;
            padding:10px 10px;
            border-radius:12px;
            border:1px solid rgba(148,163,184,0.35);
            background:rgba(15,23,42,0.9);
            margin-bottom:8px;
        }

        body.light .notif-item {
            background:#f9fafb;
        }

        .notif-item.unread {
            border-color:var(--primary-light);
            box-shadow:0 0 0 1px rgba(59,130,246,0.5);
        }

        .notif-top-row {
            display:flex;
            justify-content:space-between;
            align-items:center;
            font-size:12px;
        }

        .notif-from {
            font-weight:600;
        }

        .notif-meta {
            font-size:11px;
            color:var(--text-muted);
        }

        .notif-message {
            font-size:13px;
            margin-top:2px;
        }

        .notif-actions {
            display:flex;
            gap:6px;
            margin-top:6px;
            justify-content:flex-end;
        }

        .btn-xs {
            border-radius:999px;
            border:1px solid var(--border-subtle);
            background:transparent;
            color:var(--text-muted);
            font-size:11px;
            padding:3px 8px;
            cursor:pointer;
        }

        .btn-xs-primary {
            border-color:var(--primary-light);
            color:#bfdbfe;
        }

        body.light .btn-xs-primary {
            color:#1d4ed8;
        }

        /* إرسال إشعار */
        .field-label {
            font-size:13px;
            margin-bottom:4px;
        }

        .field-muted {
            font-size:11px;
            color:var(--text-muted);
            margin-bottom:4px;
        }

        .select-row {
            display:flex;
            gap:8px;
            flex-wrap:wrap;
            margin-bottom:8px;
        }

        .select-row select,
        .select-row input {
            flex:1;
            min-width:120px;
            padding:7px 9px;
            border-radius:10px;
            border:1px solid var(--border-subtle);
            background:rgba(15,23,42,0.85);
            color:var(--text-main);
            font-size:13px;
            outline:none;
        }

        body.light .select-row select,
        body.light .select-row input {
            background:#ffffff;
            color:#0f172a;
        }

        textarea {
            width:100%;
            min-height:120px;
            resize:vertical;
            padding:8px 10px;
            border-radius:12px;
            border:1px solid var(--border-subtle);
            background:rgba(15,23,42,0.9);
            color:var(--text-main);
            font-size:13px;
            outline:none;
        }

        body.light textarea {
            background:#ffffff;
            color:#0f172a;
        }

        .send-row {
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-top:10px;
        }

        .send-left {
            font-size:11px;
            color:var(--text-muted);
        }

        .btn-primary {
            border-radius:999px;
            padding:9px 16px;
            border:none;
            cursor:pointer;
            background:linear-gradient(135deg,var(--primary),var(--primary-light));
            color:white;
            font-size:13px;
        }

        .btn-outline {
            border-radius:999px;
            padding:7px 11px;
            border:1px solid var(--border-subtle);
            background:transparent;
            color:var(--text-muted);
            font-size:11px;
            cursor:pointer;
        }

        /* Toast */
        .toast {
            position:fixed;
            bottom:18px;
            left:18px;
            padding:10px 14px;
            border-radius:12px;
            background:rgba(15,23,42,0.96);
            border:1px solid rgba(148,163,184,0.6);
            color:#e5e7eb;
            font-size:12px;
            max-width:260px;
            box-shadow:0 18px 35px rgba(0,0,0,0.7);
            z-index:1000;
            display:none;
        }

        body.light .toast {
            background:#ffffff;
            color:#0f172a;
        }

        .toast-title {
            font-weight:600;
            margin-bottom:4px;
        }

        .toast-close {
            position:absolute;
            top:4px;
            left:8px;
            border:none;
            background:transparent;
            color:inherit;
            cursor:pointer;
            font-size:13px;
        }

        .footer {
            margin-top:26px;
            text-align:center;
            font-size:12px;
            color:var(--text-muted);
        }

        .footer span {
            color:var(--primary-light);
        }
    </style>
</head>
<body class="dark">

<script>
    // ===== حماية الصفحة =====
    (function guard() {
        const user = JSON.parse(localStorage.getItem("ghasiq_user") || "null");
        if (!user || !user.login) {
            window.location.href = "login.html";
        }
        window.__gh_user = user;
    })();
</script>

<div class="page">

    <!-- NAVBAR -->
    <header class="navbar">
        <div class="navbar-left">
            <a href="index.html">
                <img src="logo.png" alt="GHASIQ Logo" class="logo" />
            </a>

          <nav class="nav-links">
    <a href="index.html#about">عن Ghasiq</a>
    <a href="services.html">الخدمات</a>
    <a href="call-system.html">نظام الاتصال</a>
    <a href="notifications.html">الإشعارات</a>
    <a href="admin-users.html" id="navAdminLink" style="display:none;">إدارة المستخدمين</a>
</nav>


        </div>

        <div class="nav-actions">
            <span id="userChip" class="user-chip">User</span>

            <button class="btn-toggle-theme" id="langToggle" type="button">
                <span id="langLabel">AR</span>
            </button>

            <button class="btn-toggle-theme" id="themeToggle" type="button">
                <span id="themeLabel">Dark</span>
                <span id="themeIcon">☾</span>
            </button>

            <button class="btn-logout" type="button" onclick="logout()" data-i18n="btn_logout">تسجيل الخروج</button>
        </div>
    </header>

    <!-- MAIN LAYOUT -->
    <section class="layout">

        <!-- قائمة الإشعارات -->
        <div class="card">
            <div class="card-header">
                <div>
                    <div class="card-title">الإشعارات الواردة</div>
                    <div class="card-sub">تظهر هنا كل الإشعارات المرسلة إليك، سواء وأنت Online أو كنت خارج النظام.</div>
                </div>
                <div>
                    <span style="font-size:11px; color:var(--text-muted);">عدد الإشعارات غير المقروءة:</span>
                    <span id="unreadCountBadge" class="badge" style="margin-right:4px;">0</span>
                </div>
            </div>

            <div id="notificationsList" class="notifications-list">
                <!-- يتم ملؤها بالـ JS -->
            </div>
        </div>

        <!-- إرسال إشعار -->
        <div class="card">
            <div class="card-header">
                <div>
                    <div class="card-title">إرسال إشعار داخلي</div>
                    <div class="card-sub">اختر نوع الإرسال، اكتب الرسالة، وسيتم توصيلها للي أونلاين لايف، واللي Offline هتوصلهم عند أول دخول.</div>
                </div>
                <div>
                    <span style="font-size:11px; color:var(--text-muted);">المتصلين الآن:</span>
                    <span id="onlineCountBadge" class="badge" style="background:#22c55e; color:#022c22;">0</span>
                </div>
            </div>

            <div>
                <div class="field-label">نوع الإرسال:</div>
                <div class="select-row">
                    <select id="sendModeSelect">
                        <option value="all_offline">إلى جميع الموظفين غير المتصلين الآن</option>
                        <option value="all_online">إلى جميع الموظفين المتصلين الآن</option>
                        <option value="specific_user">إلى موظف محدد</option>
                        <option value="specific_role">إلى قسم / دور معين</option>
                    </select>

                    <!-- قيمة إضافية حسب النوع -->
                    <input id="targetValueInput" type="text" placeholder="مثال: GHASIQ-IT-HEAD أو email أو role" />
                </div>

                <div class="field-muted">
                    * انت مش هتتبعتلك إشعارات لنفسك أو لنفس حسابك حتى لو اخترت All.
                </div>

                <div class="field-label" style="margin-top:8px;">نص الإشعار:</div>
                <textarea id="messageInput" placeholder="اكتب هنا محتوى الإشعار الذي تريد إرساله..."></textarea>

                <div class="send-row">
                    <div class="send-left">
                        الإشعارات تحفظ في السيرفر كـ Unread للمستخدم حتى يفتح النظام.
                    </div>
                    <div style="display:flex; gap:6px;">
                        <button id="btnClearForm" type="button" class="btn-outline">مسح الحقول</button>
                        <button id="btnSendNotification" type="button" class="btn-primary">إرسال الإشعار</button>
                    </div>
                </div>
            </div>
        </div>

    </section>

    <footer class="footer" data-i18n="footer_text">
        © <span>Ghasiq</span> Logistical Support & Operations — جميع الحقوق محفوظة.
    </footer>
</div>

<!-- Toast -->
<div id="notifToast" class="toast">
    <button class="toast-close" onclick="hideToast()">✕</button>
    <div class="toast-title" id="toastTitle">إشعار جديد</div>
    <div class="toast-body" id="toastBody">محتوى الإشعار</div>
</div>

<script>
    // ===== Theme & User =====
    const bodyEl = document.body;
    const themeToggle = document.getElementById("themeToggle");
    const themeLabel = document.getElementById("themeLabel");
    const themeIcon = document.getElementById("themeIcon");
    const userChip = document.getElementById("userChip");
    const currentUser = window.__gh_user || { username: "User", role: "User", userId: "local-user" };

    function applyTheme(mode) {
        if (mode === "light") {
            bodyEl.classList.add("light");
            bodyEl.classList.remove("dark");
            themeLabel.textContent = "Light";
            themeIcon.textContent = "☀";
        } else {
            bodyEl.classList.add("dark");
            bodyEl.classList.remove("light");
            themeLabel.textContent = "Dark";
            themeIcon.textContent = "☾";
        }
        localStorage.setItem("ghasiq_theme", mode);
    }

    function initTheme() {
        const saved = localStorage.getItem("ghasiq_theme") || "dark";
        applyTheme(saved);
    }

    themeToggle.addEventListener("click", () => {
        const isLight = bodyEl.classList.contains("light");
        applyTheme(isLight ? "dark" : "light");
    });

    initTheme();

    if (currentUser && userChip) {
        userChip.textContent = `${currentUser.username} (${currentUser.role})`;
    }

    function logout() {
        localStorage.removeItem("ghasiq_user");
        window.location.href = "login.html";
    }

    // ===== Toast helpers =====
    const toastEl = document.getElementById("notifToast");
    const toastTitleEl = document.getElementById("toastTitle");
    const toastBodyEl = document.getElementById("toastBody");
    let toastTimeout = null;

    function showToast(title, body) {
        toastTitleEl.textContent = title || "إشعار جديد";
        toastBodyEl.textContent = body || "";
        toastEl.style.display = "block";
        if (toastTimeout) clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => hideToast(), 6000);
    }

    function hideToast() {
        toastEl.style.display = "none";
    }

    // ===== Notifications State (محلي بس) =====
    const notificationsListEl = document.getElementById("notificationsList");
    const unreadBadge = document.getElementById("unreadCountBadge");
    const navNotifBadge = document.getElementById("navNotifBadge");
    const onlineBadge = document.getElementById("onlineCountBadge");

    const sendModeSelect = document.getElementById("sendModeSelect");
    const targetValueInput = document.getElementById("targetValueInput");
    const messageInput = document.getElementById("messageInput");
    const btnSendNotification = document.getElementById("btnSendNotification");
    const btnClearForm = document.getElementById("btnClearForm");

    let notifications = [];   // { id, message, fromName, createdAtText, isRead }
    let unreadCount = 0;
    let onlineCount = 1; // تجريبي

    function renderNotifications() {
        notificationsListEl.innerHTML = "";
        if (!notifications || notifications.length === 0) {
            notificationsListEl.innerHTML = "<div style='font-size:13px; color:var(--text-muted);'>لا توجد إشعارات حتى الآن.</div>";
            unreadBadge.textContent = "0";
            navNotifBadge.style.display = "none";
            return;
        }

        notifications.forEach(n => {
            const wrapper = document.createElement("div");
            wrapper.className = "notif-item" + (n.isRead ? "" : " unread");

            const topRow = document.createElement("div");
            topRow.className = "notif-top-row";

            const fromSpan = document.createElement("span");
            fromSpan.className = "notif-from";
            fromSpan.textContent = n.fromName || "غير معروف";

            const metaSpan = document.createElement("span");
            metaSpan.className = "notif-meta";
            metaSpan.textContent = n.createdAtText || "";

            topRow.appendChild(fromSpan);
            topRow.appendChild(metaSpan);

            const msgDiv = document.createElement("div");
            msgDiv.className = "notif-message";
            msgDiv.textContent = n.message || "";

            const actionsDiv = document.createElement("div");
            actionsDiv.className = "notif-actions";

            if (!n.isRead) {
                const btnRead = document.createElement("button");
                btnRead.className = "btn-xs btn-xs-primary";
                btnRead.textContent = "تعليم كمقروء";
                btnRead.addEventListener("click", () => markNotificationAsRead(n));
                actionsDiv.appendChild(btnRead);
            }

            wrapper.appendChild(topRow);
            wrapper.appendChild(msgDiv);
            if (actionsDiv.children.length > 0) {
                wrapper.appendChild(actionsDiv);
            }

            notificationsListEl.appendChild(wrapper);
        });

        unreadBadge.textContent = unreadCount.toString();
        if (unreadCount > 0) {
            navNotifBadge.style.display = "inline-flex";
            navNotifBadge.textContent = unreadCount.toString();
        } else {
            navNotifBadge.style.display = "none";
        }
    }

    function markNotificationAsRead(n) {
        if (!n || n.isRead) return;
        n.isRead = true;
        unreadCount = notifications.filter(x => !x.isRead).length;
        renderNotifications();
        // مفيش API – كله محلي
    }

    function setOnlineCount(count) {
        onlineCount = count || 0;
        onlineBadge.textContent = onlineCount.toString();
    }

    // تحميل/حفظ محلي في localStorage بنفس المتصفح
    function loadLocalNotifications() {
        const key = `ghasiq_notifs_${currentUser.username || "local"}`;
        const raw = localStorage.getItem(key);
        if (!raw) {
            notifications = [];
            unreadCount = 0;
            renderNotifications();
            return;
        }
        notifications = JSON.parse(raw);
        unreadCount = notifications.filter(n => !n.isRead).length;
        renderNotifications();
    }

    function saveLocalNotifications() {
        const key = `ghasiq_notifs_${currentUser.username || "local"}`;
        localStorage.setItem(key, JSON.stringify(notifications));
    }

    // ===== إرسال إشعار (محلي) =====
    function sendNotification() {
        const mode = sendModeSelect.value;
        const targetValue = targetValueInput.value.trim();
        const message = messageInput.value.trim();

        if (!message) {
            alert("من فضلك اكتب نص الإشعار.");
            return;
        }

        const n = {
            id: Date.now(),
            message: message,
            fromName: currentUser.username || "Ghasiq",
            isRead: false,
            createdAtText: "الآن"
        };

        // تجريبي: هنضيفه على طول لنفس المستخدم
        notifications.unshift(n);
        unreadCount++;
        saveLocalNotifications();
        renderNotifications();

        showToast("تم إرسال الإشعار (محلي)", "هذا مجرد وضع تجريبي بدون باك-إند.");
        clearForm();
    }

    function clearForm() {
        messageInput.value = "";
    }

    btnSendNotification.addEventListener("click", sendNotification);
    btnClearForm.addEventListener("click", clearForm);

    // ===== Language =====
    const translations = {
        ar: {},
        en: {
            page_title: "Ghasiq - Internal Notifications",
            nav_about: "About Ghasiq",
            nav_services: "Services",
            nav_call_system: "Call System",
            nav_notifications: "Notifications",
            btn_logout: "Log out",
            footer_text: "© <span>Ghasiq</span> Logistical Support & Operations — All rights reserved."
        }
    };

    function initArabicFromDom() {
        document.querySelectorAll("[data-i18n]").forEach(el => {
            const key = el.getAttribute("data-i18n");
            if (!translations.ar[key]) {
                translations.ar[key] = el.innerHTML;
            }
        });
        translations.ar.page_title = document.title;
    }

    function applyTranslations(lang) {
        document.querySelectorAll("[data-i18n]").forEach(el => {
            const key = el.getAttribute("data-i18n");
            const value = translations[lang] && translations[lang][key];
            if (!value) return;
            el.innerHTML = value;
        });
        if (translations[lang].page_title) {
            document.title = translations[lang].page_title;
        }
    }

    function applyLanguage(lang) {
        localStorage.setItem("ghasiq_lang", lang);

        if (lang === "en") {
            document.documentElement.setAttribute("dir", "ltr");
            document.documentElement.lang = "en";
            document.getElementById("langLabel").textContent = "EN";
        } else {
            document.documentElement.setAttribute("dir", "rtl");
            document.documentElement.lang = "ar";
            document.getElementById("langLabel").textContent = "AR";
        }

        applyTranslations(lang);
    }

    function initLanguageToggle() {
        initArabicFromDom();

        const saved = localStorage.getItem("ghasiq_lang") || "ar";
        applyLanguage(saved);

        const langToggle = document.getElementById("langToggle");
        if (!langToggle) return;

        langToggle.addEventListener("click", () => {
            const current = localStorage.getItem("ghasiq_lang") || "ar";
            const nextLang = current === "ar" ? "en" : "ar";
            applyLanguage(nextLang);
        });
    }

    // ===== Init =====
    window.addEventListener("load", () => {
        setOnlineCount(1);          // تجريبي
        loadLocalNotifications();   // من نفس المتصفح فقط
        initLanguageToggle();
    });
</script>
<script>
(function handleAdminNav() {
    const adminLink = document.getElementById("navAdminLink");
    const userChip  = document.getElementById("userChip");

    let u = null;
    try {
        u = JSON.parse(localStorage.getItem("ghasiq_user") || "null");
    } catch { u = null; }

    // تحديث الشيب اللي فوق باسم اليوزر (لو موجود)
    if (userChip && u && u.username) {
        const role = u.role || (u.isAdmin || u.is_admin ? "admin" : "user");
        userChip.textContent = `${u.username} (${role})`;
    }

    if (!adminLink) return;

    // لو أدمن → أظهر اللينك
    if (u && u.login && (u.isAdmin || u.is_admin == 1 || u.role === "admin")) {
        adminLink.style.display = "inline-flex";
    } else {
        adminLink.style.display = "none";
    }
})();
</script>



</body>
</html>
