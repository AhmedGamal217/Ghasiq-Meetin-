<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <title>Ghasiq - نظام الاتصال الداخلي</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet" />
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --accent: #22c55e;

            --bg-main: #020617;
            --bg-elevated: rgba(15, 23, 42, 0.94);
            --bg-card: rgba(15, 23, 42, 0.98);
            --border-subtle: rgba(148, 163, 184, 0.35);

            --text-main: #e5e7eb;
            --text-muted: #9ca3af;
            --shadow-strong: 0 20px 45px rgba(0, 0, 0, 0.8);
        }

        body.light {
            --bg-main: #f5f7fb;
            --bg-elevated: #ffffff;
            --bg-card: #ffffff;
            --border-subtle: rgba(148, 163, 184, 0.5);
            --text-main: #0f172a;
            --text-muted: #6b7280;
            --shadow-strong: 0 20px 45px rgba(15, 23, 42, 0.15);
        }

        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family:"Cairo",system-ui;
            background:
                radial-gradient(circle at top left, rgba(37, 99, 235, 0.35), transparent 55%),
                radial-gradient(circle at bottom right, rgba(56, 189, 248, 0.28), transparent 55%),
                linear-gradient(135deg, #00020b, var(--bg-main) 45%, #00010a);
            color:var(--text-main);
            min-height:100vh;
        }

        body.light {
            background:
                radial-gradient(circle at top left, rgba(191, 219, 254, 0.7), transparent 55%),
                radial-gradient(circle at bottom right, rgba(219, 234, 254, 0.7), transparent 55%),
                linear-gradient(135deg, #e5edff, #f9fafb 50%, #eff6ff);
        }

        a { text-decoration:none; color:inherit; }

        .page {
            max-width:1140px;
            margin:0 auto;
            padding:20px 18px 40px;
        }

        /* NAVBAR */
        .navbar {
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:14px 18px;
            border-radius:16px;
            background:var(--bg-elevated);
            box-shadow:
                0 16px 35px rgba(0,0,0,0.75),
                0 0 0 1px rgba(148,163,184,0.3);
            margin-bottom:26px;
            backdrop-filter:blur(14px);
        }

        .navbar-left {
            display:flex;
            align-items:center;
            gap:14px;
        }

        .logo {
            height:46px;
            cursor:pointer;
        }

        .nav-links {
            display:flex;
            gap:16px;
            font-size:14px;
            color:var(--text-muted);
        }

        .nav-links a {
            position:relative;
            padding-bottom:4px;
        }

        .nav-links a::after {
            content:"";
            position:absolute;
            right:0;
            bottom:0;
            width:0;
            height:2px;
            border-radius:999px;
            background:linear-gradient(90deg,var(--primary-light),var(--primary));
            transition:width .18s ease;
        }

        .nav-links a:hover::after {
            width:100%;
        }

        .nav-links a.active {
            color:#e5e7eb;
            font-weight:600;
        }

        .nav-links a.active::after {
            width:100%;
        }

        .nav-actions {
            display:flex;
            align-items:center;
            gap:8px;
        }

        .btn-toggle-theme,
        .btn-logout,
        .btn-sm-outline {
            border-radius:999px;
            padding:6px 12px;
            font-size:12px;
            cursor:pointer;
            border:1px solid var(--border-subtle);
            background:rgba(15,23,42,0.85);
            color:#e5e7eb;
        }

        body.light .btn-toggle-theme,
        body.light .btn-logout,
        body.light .btn-sm-outline {
            background:#ffffff;
            color:#0f172a;
        }

        .btn-sm-outline {
            border-color:var(--primary-light);
            color:#dbeafe;
        }

        body.light .btn-sm-outline {
            color:#1d4ed8;
        }

        .btn-logout {
            border-color:#f97373;
            color:#fecaca;
        }

        body.light .btn-logout {
            color:#b91c1c;
        }

        .user-chip {
            font-size:11px;
            padding:4px 10px;
            border-radius:999px;
            border:1px solid rgba(148,163,184,0.7);
            color:var(--text-muted);
        }

        /* LAYOUT */
        .call-layout {
            display:grid;
            grid-template-columns:minmax(0,1.4fr) minmax(0,1fr);
            gap:20px;
        }

        @media(max-width:900px){
            .call-layout { grid-template-columns:1fr; }
        }

        .call-card {
            border-radius:22px;
            background:var(--bg-elevated);
            border:1px solid var(--border-subtle);
            box-shadow:var(--shadow-strong);
            padding:18px 18px 20px;
        }

        .call-header {
            margin-bottom:12px;
        }

        .call-header-title {
            font-size:18px;
            margin-bottom:4px;
        }

        .call-header-sub {
            font-size:13px;
            color:var(--text-muted);
        }

        .video-grid {
            display:grid;
            grid-template-columns:1fr;
            gap:12px;
        }

        .video-box {
            border-radius:16px;
            background:var(--bg-card);
            border:1px solid var(--border-subtle);
            padding:10px;
        }

        .video-label {
            font-size:12px;
            color:var(--text-muted);
            margin-bottom:6px;
        }

        video {
            width:100%;
            border-radius:10px;
            background:#000;
        }

        .status-bar {
            margin-top:8px;
            font-size:12px;
            color:var(--text-muted);
        }

        .status-green {
            color:#22c55e;
        }

        .controls-box {
            border-radius:22px;
            background:var(--bg-elevated);
            border:1px solid var(--border-subtle);
            box-shadow:var(--shadow-strong);
            padding:18px 18px 18px;
        }

        .id-row {
            margin-bottom:12px;
            font-size:13px;
        }

        .my-id {
            padding:8px 10px;
            border-radius:10px;
            background:var(--bg-card);
            border:1px solid rgba(56,189,248,0.4);
            font-size:12px;
            word-break:break-all;
        }

        .remote-input-row {
            margin-top:10px;
            display:flex;
            flex-direction:column;
            gap:6px;
        }

        .remote-input-row input {
            width:100%;
            padding:8px 10px;
            border-radius:8px;
            border:1px solid var(--border-subtle);
            background:rgba(15,23,42,0.85);
            color:var(--text-main);
            font-size:13px;
            outline:none;
        }

        body.light .remote-input-row input {
            background:#ffffff;
            color:#0f172a;
        }

        .buttons-row {
            display:flex;
            flex-wrap:wrap;
            gap:8px;
            margin-top:10px;
        }

        .btn-primary {
            border-radius:999px;
            padding:9px 16px;
            border:none;
            cursor:pointer;
            background:linear-gradient(135deg,var(--primary),var(--primary-light));
            color:white;
            font-size:13px;
        }

        .btn-danger {
            border-radius:999px;
            padding:9px 16px;
            border:none;
            cursor:pointer;
            background:linear-gradient(135deg,#b91c1c,#ef4444);
            color:white;
            font-size:13px;
        }

        .hint {
            margin-top:12px;
            font-size:12px;
            color:var(--text-muted);
        }

        .hint span {
            color:var(--primary-light);
        }

        .footer {
            margin-top:26px;
            text-align:center;
            font-size:12px;
            color:var(--text-muted);
        }

        .footer span {
            color:var(--primary-light);
        }
    </style>
</head>
<body class="dark">

<!-- حماية الصفحة -->
<script>
    (function guard() {
        const user = JSON.parse(localStorage.getItem("ghasiq_user") || "null");
        if (!user || !user.login) {
            window.location.href = "login.html";
        }
        window.__gh_user = user;
    })();
</script>

<div class="page">

    <!-- NAVBAR -->
    <header class="navbar">
        <div class="navbar-left">
            <a href="index.html">
                <img src="logo.png" alt="GHASIQ Logo" class="logo" />
            </a>

            <nav class="nav-links">
                <a href="index.html#about">عن Ghasiq</a>
                <a href="services.html">الخدمات</a>
                <a href="call-system.html" class="active">نظام الاتصال</a>
                <a href="notifications.html">الإشعارات</a>
            </nav>
        </div>

        <div class="nav-actions">
            <span id="userChip" class="user-chip">User</span>
            <button class="btn-toggle-theme" id="themeToggle" type="button">
                <span id="themeLabel">Dark</span>
                <span id="themeIcon">☾</span>
            </button>
            <button class="btn-logout" type="button" onclick="logout()">تسجيل الخروج</button>
        </div>
    </header>

    <section class="call-layout">
        <!-- فيديو -->
        <div class="call-card">
            <div class="call-header">
                <div class="call-header-title">غرفة الاتصال الداخلي للموظفين</div>
                <div class="call-header-sub">
                    استخدم هذه الغرفة لاجتماعات التشغيل السريعة بين أقسام Ghasiq
                    (التشغيل، الصيانة، الموارد البشرية، المالية، الإدارة العامة).
                </div>
            </div>

            <div class="video-grid">
                <div class="video-box">
                    <div class="video-label">الفيديو الخاص بك</div>
                    <video id="localVideo" autoplay muted playsinline></video>
                </div>
                <div class="video-box">
                    <div class="video-label">الطرف الآخر</div>
                    <video id="remoteVideo" autoplay playsinline></video>
                </div>
            </div>

            <div class="status-bar">
                حالة الاتصال: <span id="callStatus" class="status-green">جاهز لبدء مكالمة</span>
            </div>
        </div>

        <!-- كنترول -->
        <div class="controls-box">
            <div class="call-header">
                <div class="call-header-title">إدارة الاتصال</div>
                <div class="call-header-sub">
                    يتم توليد معرف ثابت بناءً على دور المستخدم. شارِك المعرف مع الموظف الآخر،
                    واطلب منه إدخاله في خانة "معرّف الطرف الآخر".
                </div>
            </div>

            <div class="id-row">
                <div style="font-size:13px; margin-bottom:4px;">المعرّف الخاص بك:</div>
                <div id="myIdBox" class="my-id">جاري التحميل...</div>
            </div>

            <div class="remote-input-row">
                <label style="font-size:13px;">معرّف الموظف الآخر:</label>
                <input id="remoteIdInput" type="text" placeholder="مثال: GHASIQ-IT-HEAD أو GHASIQ-HR-HEAD">
            </div>

            <div class="buttons-row">
                <button class="btn-primary" id="btnStartCall">بدء الاتصال</button>
                <button class="btn-danger" id="btnEndCall">إنهاء المكالمة</button>
            </div>

            <div class="hint">
                • تأكد أن الطرفين متصلين بالإنترنت.<br>
                • لكل رئيس قسم معرف ثابت، مثل:
                <span>GHASIQ-IT-HEAD</span>، <span>GHASIQ-HR-HEAD</span>،
                <span>GHASIQ-FINANCE-HEAD</span>، <span>GHASIQ-GM</span>.
            </div>
        </div>
    </section>

    <footer class="footer">
        © <span>Ghasiq</span> Logistical Support & Operations — جميع الحقوق محفوظة.
    </footer>
</div>

<script>
    // ===== Theme =====
    const bodyEl = document.body;
    const themeToggle = document.getElementById("themeToggle");
    const themeLabel = document.getElementById("themeLabel");
    const themeIcon = document.getElementById("themeIcon");

    function applyTheme(mode) {
        if (mode === "light") {
            bodyEl.classList.add("light");
            bodyEl.classList.remove("dark");
            themeLabel.textContent = "Light";
            themeIcon.textContent = "☀";
        } else {
            bodyEl.classList.add("dark");
            bodyEl.classList.remove("light");
            themeLabel.textContent = "Dark";
            themeIcon.textContent = "☾";
        }
        localStorage.setItem("ghasiq_theme", mode);
    }

    function initTheme() {
        const saved = localStorage.getItem("ghasiq_theme") || "dark";
        applyTheme(saved);
    }

    themeToggle.addEventListener("click", () => {
        const isLight = bodyEl.classList.contains("light");
        applyTheme(isLight ? "dark" : "light");
    });

    initTheme();

    // عرض اليوزر
    (function showUser() {
        const chip = document.getElementById("userChip");
        const user = window.__gh_user;
        if (!user) return;
        chip.textContent = `${user.username} (${user.role})`;
    })();

    // Logout
    function logout() {
        localStorage.removeItem("ghasiq_user");
        window.location.href = "login.html";
    }

    // ===== Ghasiq Call System / PeerJS =====
    const user = window.__gh_user || { role: "User" };

    function normalizeRole(r) {
        if (!r) return "USER";
        return r.replace(/\s+/g, "-").toUpperCase();
    }

    const baseRole = normalizeRole(user.role); // IT-HEAD, HR-HEAD, ...
    const myPeerId = "GHASIQ-" + baseRole;

    const myIdBox = document.getElementById("myIdBox");
    const remoteIdInput = document.getElementById("remoteIdInput");
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const callStatus = document.getElementById("callStatus");
    const btnStartCall = document.getElementById("btnStartCall");
    const btnEndCall = document.getElementById("btnEndCall");

    let peer = null;
    let localStream = null;
    let currentCall = null;

    function setStatus(text, isError) {
        callStatus.textContent = text;
        callStatus.classList.toggle("status-green", !isError);
        callStatus.style.color = isError ? "#f97373" : "#22c55e";
    }

    // دالة موحّدة لفتح الكاميرا/المايك
    function getMediaStream() {
        if (localStream) return Promise.resolve(localStream);

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            setStatus("المتصفح لا يدعم الكاميرا/المايك.", true);
            return Promise.reject(new Error("Media not supported"));
        }

        return navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then((stream) => {
                localStream = stream;
                localVideo.srcObject = stream;
                return stream;
            });
    }

    function bindCallEvents(call) {
        currentCall = call;
        setStatus("المكالمة نشطة", false);

        call.on("stream", (remoteStream) => {
            remoteVideo.srcObject = remoteStream;
        });

        call.on("close", () => {
            remoteVideo.srcObject = null;
            setStatus("تم إنهاء المكالمة", true);
        });

        call.on("error", (err) => {
            console.error(err);
            setStatus("حدث خطأ أثناء المكالمة", true);
        });
    }

    function initPeer() {
        peer = new Peer(myPeerId, { debug: 1 });

        peer.on("open", (id) => {
            myIdBox.textContent = id;
            setStatus("جاهز لبدء مكالمة", false);
        });

        peer.on("error", (err) => {
            console.error(err);
            setStatus("خطأ في الاتصال بخادم PeerJS. تأكد من الاتصال بالإنترنت.", true);
        });

        // مكالمة واردة + إشعار + ضمان فتح الكاميرا
        peer.on("call", (call) => {
            const from = call.peer || "موظف آخر";

            const accept = confirm(`يوجد اتصال وارد من:\n${from}\n\nهل ترغب في الرد؟`);

            if (!accept) {
                call.close();
                setStatus("تم رفض المكالمة الواردة.", true);
                return;
            }

            setStatus("جاري الرد على المكالمة...", false);

            getMediaStream()
                .then((stream) => {
                    call.answer(stream);     // نرد بالميديا
                    bindCallEvents(call);    // نربط الأحداث
                })
                .catch((err) => {
                    console.error(err);
                    setStatus("تعذر فتح الكاميرا/المايك.", true);
                    call.close();
                });
        });
    }

    // مكالمة صادرة
    btnStartCall.addEventListener("click", () => {
        const remoteIdRaw = remoteIdInput.value.trim();
        if (!remoteIdRaw) {
            alert("الرجاء إدخال معرّف الموظف الآخر.");
            return;
        }

        const remoteId = remoteIdRaw.replace(/\s+/g, "-").toUpperCase();

        setStatus("جاري بدء المكالمة...", false);

        getMediaStream()
            .then((stream) => {
                const call = peer.call(remoteId, stream);
                if (!call) {
                    setStatus("تعذر بدء المكالمة. تأكد من المعرّف.", true);
                    return;
                }
                bindCallEvents(call);
            })
            .catch((err) => {
                console.error(err);
                setStatus("تعذر فتح الكاميرا/المايك.", true);
            });
    });

    // إنهاء المكالمة
    btnEndCall.addEventListener("click", () => {
        if (currentCall) {
            currentCall.close();
            currentCall = null;
        }
        if (localStream) {
            localStream.getTracks().forEach((t) => t.stop());
            localStream = null;
            localVideo.srcObject = null;
        }
        remoteVideo.srcObject = null;
        setStatus("تم إنهاء المكالمة. جاهز لاتصال جديد.", false);
    });

    // تشغيل Peer وفتح الكاميرا عند التحميل
    initPeer();

    window.addEventListener("load", () => {
        getMediaStream().catch((err) => {
            console.error(err);
            setStatus("تعذر فتح الكاميرا/المايك. تأكد من السماح في المتصفح.", true);
        });
    });
</script>

</body>
</html>
