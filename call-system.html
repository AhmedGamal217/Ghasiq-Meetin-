<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <title>Ghasiq - Ù†Ø¸Ø§Ù… Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet" />
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --accent: #22c55e;

            --bg-main: #020617;
            --bg-elevated: rgba(15, 23, 42, 0.94);
            --bg-card: rgba(15, 23, 42, 0.98);
            --border-subtle: rgba(148, 163, 184, 0.35);

            --text-main: #e5e7eb;
            --text-muted: #9ca3af;
            --shadow-strong: 0 20px 45px rgba(0, 0, 0, 0.8);
        }

        body.light {
            --bg-main: #f5f7fb;
            --bg-elevated: #ffffff;
            --bg-card: #ffffff;
            --border-subtle: rgba(148, 163, 184, 0.5);
            --text-main: #0f172a;
            --text-muted: #6b7280;
            --shadow-strong: 0 20px 45px rgba(15, 23, 42, 0.15);
        }

        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family:"Cairo",system-ui;
            background:
                radial-gradient(circle at top left, rgba(37, 99, 235, 0.35), transparent 55%),
                radial-gradient(circle at bottom right, rgba(56, 189, 248, 0.28), transparent 55%),
                linear-gradient(135deg, #00020b, var(--bg-main) 45%, #00010a);
            color:var(--text-main);
            min-height:100vh;
        }

        .page { max-width:1140px; margin:0 auto; padding:20px 18px 40px; }

        /* NAVBAR */
        .navbar {
            display:flex; align-items:center; justify-content:space-between;
            padding:14px 18px; border-radius:16px;
            background:var(--bg-elevated);
            box-shadow:0 16px 35px rgba(0,0,0,0.75), 0 0 0 1px rgba(148,163,184,0.3);
            margin-bottom:26px; backdrop-filter:blur(14px);
        }

        .navbar-left { display:flex; align-items:center; gap:14px; }
        .logo { height:46px; cursor:pointer; }
        .nav-links { display:flex; gap:16px; color:var(--text-muted); font-size:14px; }

        .nav-links a { position:relative; padding-bottom:4px; }
        .nav-links a:hover::after { width:100%; }
        .nav-links a::after {
            content:""; position:absolute; right:0; bottom:0; height:2px; width:0;
            background:linear-gradient(90deg,var(--primary-light),var(--primary));
            border-radius:999px; transition:width .18s ease;
        }

        .nav-actions { display:flex; gap:8px; }

        .btn-toggle-theme,.btn-logout,.btn-sm-outline {
            border-radius:999px; padding:6px 12px; font-size:12px;
            border:1px solid var(--border-subtle);
            background:rgba(15,23,42,0.85); color:#e5e7eb; cursor:pointer;
        }

        .user-chip {
            font-size:11px; padding:4px 10px; border-radius:999px;
            border:1px solid rgba(148,163,184,0.7);
        }

        /* LAYOUT */
        .call-layout {
            display:grid;
            grid-template-columns:1.4fr 1fr;
            gap:20px;
        }

        .call-card,.controls-box {
            border-radius:22px;
            background:var(--bg-elevated);
            border:1px solid var(--border-subtle);
            padding:18px;
            box-shadow:var(--shadow-strong);
        }

        video { width:100%; border-radius:10px; background:#000; }

        .video-grid { display:grid; gap:12px; }

        .video-box { background:var(--bg-card); border-radius:16px; padding:10px; }
        .video-label { font-size:12px; color:var(--text-muted); margin-bottom:6px; }

        #remoteVideo { opacity:0.25; }

        .status-bar { margin-top:8px; font-size:12px; color:var(--text-muted); }
        .status-green { color:#22c55e; }

        .remote-input-row input {
            width:100%; padding:8px 10px; border-radius:8px;
            border:1px solid var(--border-subtle);
            background:rgba(15,23,42,0.85); color:var(--text-main);
        }

        .buttons-row { display:flex; gap:8px; margin-top:10px; }

        .btn-primary {
            padding:9px 16px; border-radius:999px; border:none; cursor:pointer;
            background:linear-gradient(135deg,var(--primary),var(--primary-light));
            color:white;
        }

        .btn-danger {
            padding:9px 16px; border-radius:999px; border:none; cursor:pointer;
            background:linear-gradient(135deg,#b91c1c,#ef4444); color:white;
        }

    </style>
</head>
<body class="dark">

<script>
    (function guard() {
        const user = JSON.parse(localStorage.getItem("ghasiq_user") || "null");
        if (!user || !user.login) window.location.href = "login.html";
        window.__gh_user = user;
    })();
</script>

<div class="page">

<header class="navbar">
    <div class="navbar-left">
        <a href="index.html"><img src="logo.png" class="logo"></a>
        <nav class="nav-links">
            <a href="index.html#about">Ø¹Ù† Ghasiq</a>
            <a href="services.html">Ø§Ù„Ø®Ø¯Ù…Ø§Øª</a>
            <a href="call-system.html" class="active">Ù†Ø¸Ø§Ù… Ø§Ù„Ø§ØªØµØ§Ù„</a>
            <a href="notifications.html">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</a>
        </nav>
    </div>

    <div class="nav-actions">
        <span id="userChip" class="user-chip">User</span>
        <button class="btn-toggle-theme" id="themeToggle">Dark</button>
        <button class="btn-logout" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
</header>

<section class="call-layout">
    <div class="call-card">
        <h3>ØºØ±ÙØ© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
        <p>Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</p>

        <div class="video-grid">
            <div class="video-box">
                <div class="video-label">Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</div>
                <video id="localVideo" autoplay muted playsinline></video>
            </div>
            <div class="video-box">
                <div class="video-label">Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±</div>
                <video id="remoteVideo" autoplay playsinline></video>
            </div>
        </div>

        <div class="status-bar">
            Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„: <span id="callStatus" class="status-green">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...</span>
        </div>
    </div>

    <div class="controls-box">
        <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§ØªØµØ§Ù„</h3>

        <p>Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:</p>
        <div id="myIdBox" class="my-id">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

        <div class="remote-input-row">
            <label>Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¢Ø®Ø±:</label>
            <input id="remoteIdInput" type="text" placeholder="GHASIQ-IT-HEAD">
        </div>

        <div class="buttons-row">
            <button class="btn-primary" id="btnStartCall">Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„</button>
            <button class="btn-danger" id="btnEndCall">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©</button>
        </div>
    </div>
</section>

</div>

<script>
/* ========== Theme ========== */
(function showUser() {
    const chip = document.getElementById("userChip");
    const user = window.__gh_user;
    chip.textContent = `${user.username} (${user.role})`;
})();

function logout() {
    localStorage.removeItem("ghasiq_user");
    window.location.href = "login.html";
}

/* ========== PeerJS Call System ========== */

/* Ù†ÙØ³ Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª Ø¹Ù†Ø¯Ùƒ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØºÙŠÙŠØ± */
function normalizeRole(r) {
    if (!r) return "USER";
    return r.replace(/\s+/g, "-").toUpperCase();
}

const user = window.__gh_user || { role: "User" };
const myPeerId = "GHASIQ-" + normalizeRole(user.role);

document.getElementById("myIdBox").textContent = myPeerId;

let peer = null;
let localStream = null;
let currentCall = null;

const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const callStatus = document.getElementById("callStatus");

function setStatus(txt, error=false) {
    callStatus.textContent = txt;
    callStatus.style.color = error ? "#f97373" : "#22c55e";
}

/* ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */
navigator.mediaDevices.getUserMedia({ video:true, audio:true }).then(s=>{
    localStream = s;
    localVideo.srcObject = s;
}).catch(()=> setStatus("ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§/Ø§Ù„Ù…Ø§ÙŠÙƒ", true));

/* Ø¥Ù†Ø´Ø§Ø¡ Peer */
peer = new Peer(myPeerId, { debug:1 });

peer.on("open", ()=> setStatus("Ø¬Ø§Ù‡Ø² Ù„Ø¨Ø¯Ø¡ Ù…ÙƒØ§Ù„Ù…Ø©"));

peer.on("error", err => {
    console.error(err);
    setStatus("Ø®Ø·Ø£ ÙÙŠ PeerJS", true);
});

/* ========== Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„ÙˆØ§Ø±Ø¯Ø© (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯) ========== */
peer.on("call", call => {
    const from = call.peer || "Ù…ÙˆØ¸Ù Ø¢Ø®Ø±";

    const accept = confirm(`ğŸ“ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ ÙˆØ§Ø±Ø¯ Ù…Ù†:\n${from}\n\nÙ‡Ù„ ØªØ±ØºØ¨ ÙÙŠ Ø§Ù„Ø±Ø¯ØŸ`);

    if (!accept) {
        call.close();
        setStatus("ØªÙ… Ø±ÙØ¶ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„ÙˆØ§Ø±Ø¯Ø©", true);
        return;
    }

    setStatus("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©...");
    call.answer(localStream);

    call.on("stream", remoteStream => {
        remoteVideo.srcObject = remoteStream;
        setStatus("Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ù†Ø´Ø·Ø©");
    });

    call.on("close", ()=>{
        remoteVideo.srcObject = null;
        setStatus("ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©");
    });

    currentCall = call;
});

/* ========== Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ ========== */
document.getElementById("btnStartCall").onclick = () => {
    const remoteId = document.getElementById("remoteIdInput").value.trim();
    if (!remoteId) return alert("Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¢Ø®Ø±");

    setStatus("Ø¬Ø§Ø±ÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©...");

    const call = peer.call(remoteId, localStream);

    call.on("stream", remoteStream => {
        remoteVideo.srcObject = remoteStream;
        setStatus("Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ù†Ø´Ø·Ø©");
    });

    call.on("close", ()=>{
        remoteVideo.srcObject = null;
        setStatus("ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©");
    });

    currentCall = call;
};

/* ========== Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© ========== */
document.getElementById("btnEndCall").onclick = () => {
    if (currentCall) currentCall.close();

    remoteVideo.srcObject = null;
    setStatus("ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©");
};
</script>

</body>
</html>
