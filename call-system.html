<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <title>Ghasiq - Ù†Ø¸Ø§Ù… Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet" />
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --accent: #22c55e;

            --bg-main: #020617;
            --bg-elevated: rgba(15, 23, 42, 0.94);
            --bg-card: rgba(15, 23, 42, 0.98);
            --border-subtle: rgba(148, 163, 184, 0.35);

            --text-main: #e5e7eb;
            --text-muted: #9ca3af;
            --shadow-strong: 0 20px 45px rgba(0, 0, 0, 0.8);
        }

        body.light {
            --bg-main: #f5f7fb;
            --bg-elevated: #ffffff;
            --bg-card: #ffffff;
            --border-subtle: rgba(148, 163, 184, 0.5);
            --text-main: #0f172a;
            --text-muted: #6b7280;
            --shadow-strong: 0 20px 45px rgba(15, 23, 42, 0.15);
        }

        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family:"Cairo",system-ui;
            background:
                radial-gradient(circle at top left, rgba(37, 99, 235, 0.35), transparent 55%),
                radial-gradient(circle at bottom right, rgba(56, 189, 248, 0.28), transparent 55%),
                linear-gradient(135deg, #00020b, var(--bg-main) 45%, #00010a);
            color:var(--text-main);
            min-height:100vh;
        }

        body.light {
            background:
                radial-gradient(circle at top left, rgba(191, 219, 254, 0.7), transparent 55%),
                radial-gradient(circle at bottom right, rgba(219, 234, 254, 0.7), transparent 55%),
                linear-gradient(135deg, #e5edff, #f9fafb 50%, #eff6ff);
        }

        a { text-decoration:none; color:inherit; }

        .page {
            max-width:1140px;
            margin:0 auto;
            padding:20px 18px 40px;
        }

        /* NAVBAR */
        .navbar {
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:14px 18px;
            border-radius:16px;
            background:var(--bg-elevated);
            box-shadow:
                0 16px 35px rgba(0,0,0,0.75),
                0 0 0 1px rgba(148,163,184,0.3);
            margin-bottom:26px;
            backdrop-filter:blur(14px);
        }

        .navbar-left {
            display:flex;
            align-items:center;
            gap:14px;
        }

        .logo {
            height:46px;
            cursor:pointer;
        }

        .nav-links {
            display:flex;
            gap:16px;
            font-size:14px;
            color:var(--text-muted);
        }

        .nav-links a {
            position:relative;
            padding-bottom:4px;
        }

        .nav-links a::after {
            content:"";
            position:absolute;
            right:0;
            bottom:0;
            width:0;
            height:2px;
            border-radius:999px;
            background:linear-gradient(90deg,var(--primary-light),var(--primary));
            transition:width .18s ease;
        }

        .nav-links a:hover::after {
            width:100%;
        }

        .nav-links a.active {
            color:#e5e7eb;
            font-weight:600;
        }

        .nav-links a.active::after {
            width:100%;
        }

        .nav-actions {
            display:flex;
            align-items:center;
            gap:8px;
        }

        .btn-toggle-theme,
        .btn-logout,
        .btn-sm-outline {
            border-radius:999px;
            padding:6px 12px;
            font-size:12px;
            cursor:pointer;
            border:1px solid var(--border-subtle);
            background:rgba(15,23,42,0.85);
            color:#e5e7eb;
        }

        body.light .btn-toggle-theme,
        body.light .btn-logout,
        body.light .btn-sm-outline {
            background:#ffffff;
            color:#0f172a;
        }

        .btn-sm-outline {
            border-color:var(--primary-light);
            color:#dbeafe;
        }

        body.light .btn-sm-outline {
            color:#1d4ed8;
        }

        .btn-logout {
            border-color:#f97373;
            color:#fecaca;
        }

        body.light .btn-logout {
            color:#b91c1c;
        }

        .user-chip {
            font-size:11px;
            padding:4px 10px;
            border-radius:999px;
            border:1px solid rgba(148,163,184,0.7);
            color:var(--text-muted);
        }

        /* LAYOUT */
        .call-layout {
            display:grid;
            grid-template-columns: minmax(0, 320px) minmax(0, 1fr);
            gap:22px;
            align-items:flex-start;
        }

        @media(max-width:900px){
            .call-layout {
                grid-template-columns:1fr;
            }

            .call-card {
                order:1;
                max-width:100%;
            }

            .controls-box {
                order:2;
            }
        }

        .call-card {
            border-radius:22px;
            background:var(--bg-elevated);
            border:1px solid var(--border-subtle);
            box-shadow:var(--shadow-strong);
            padding:18px 18px 20px;
            max-width:820px;
            margin-inline:auto;
        }

        .controls-box {
            border-radius:20px;
            background:var(--bg-elevated);
            border:1px solid var(--border-subtle);
            box-shadow:var(--shadow-strong);
            padding:16px 14px 18px;
            display:flex;
            flex-direction:column;
            gap:14px;
            position:relative;
        }

        @media(min-width:901px){
            .controls-box {
                position:sticky;
                top:90px;
                height:fit-content;
            }
        }

        .sidebar-header {
            border-bottom:1px solid rgba(148,163,184,0.25);
            padding-bottom:10px;
            margin-bottom:6px;
        }

        .sidebar-section {
            padding:6px 2px;
            border-bottom:1px dashed rgba(148,163,184,0.25);
        }

        .sidebar-section:last-of-type {
            border-bottom:none;
        }

        .sidebar-hint {
            font-size:11px;
        }

        .call-header {
            margin-bottom:12px;
        }

        .call-header-title {
            font-size:18px;
            margin-bottom:4px;
        }

        .call-header-sub {
            font-size:13px;
            color:var(--text-muted);
        }

        @media(max-width:600px){
            .call-header-title { font-size:16px; }
            .call-header-sub { font-size:12px; }
        }

        .video-grid {
            display:grid;
            grid-template-columns:repeat(2, minmax(0, 1fr));
            gap:12px;
            align-items:stretch;
        }

        @media(max-width:900px){
            .video-grid {
                grid-template-columns:1fr;
            }
        }

        .video-box {
            border-radius:16px;
            background:var(--bg-card);
            border:1px solid var(--border-subtle);
            padding:10px;
            display:flex;
            flex-direction:column;
        }

        .video-label {
            font-size:12px;
            color:var(--text-muted);
            margin-bottom:6px;
        }

        .video-inner {
            position:relative;
        }

        video {
            width:100%;
            border-radius:10px;
            background:#000;
            flex:1;
        }

        /* Mirror Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù…Ø­Ù„ÙŠØ© */
        #localVideo {
            transform: scaleX(-1);
        }

        /* Grid Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ÙƒØªÙŠØ± */
        .remote-grid {
            display:grid;
            grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));
            gap:8px;
        }

        .remote-video-wrapper {
            position:relative;
        }

        .remote-video-wrapper video {
            width:100%;
            height:100%;
            object-fit:cover;
            border-radius:10px;
            background:#000;
        }

        .remote-peer-label {
            position:absolute;
            bottom:6px;
            right:8px;
            padding:2px 8px;
            border-radius:999px;
            background:rgba(15,23,42,0.8);
            border:1px solid rgba(148,163,184,0.5);
            font-size:10px;
        }

        /* Ø²Ø± ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø´Ø§Ø´Ø© */
        .fullscreen-btn {
            position:absolute;
            top:8px;
            left:8px;
            border:none;
            border-radius:999px;
            padding:3px 8px;
            font-size:11px;
            cursor:pointer;
            background:rgba(15,23,42,0.85);
            color:#e5e7eb;
        }

        body.light .fullscreen-btn {
            background:rgba(255,255,255,0.9);
            color:#0f172a;
        }

        .status-bar {
            margin-top:8px;
            font-size:12px;
            color:var(--text-muted);
            display:flex;
            flex-wrap:wrap;
            gap:6px;
            align-items:center;
        }

        .status-green {
            color:#22c55e;
        }

        .status-timer-label,
        .status-participants-label {
            margin-inline-start:10px;
        }

        .status-timer,
        .status-participants {
            font-family:monospace;
        }

        .id-row {
            margin-bottom:12px;
            font-size:13px;
        }

        .my-id {
            padding:8px 10px;
            border-radius:10px;
            background:var(--bg-card);
            border:1px solid rgba(56,189,248,0.4);
            font-size:12px;
            word-break:break-all;
        }

        .remote-input-row {
            margin-top:10px;
            display:flex;
            flex-direction:column;
            gap:6px;
        }

        .remote-input-row input {
            width:100%;
            padding:8px 10px;
            border-radius:8px;
            border:1px solid var(--border-subtle);
            background:rgba(15,23,42,0.85);
            color:var(--text-main);
            font-size:13px;
            outline:none;
        }

        body.light .remote-input-row input {
            background:#ffffff;
            color:#0f172a;
        }

        .buttons-row {
            display:flex;
            flex-wrap:wrap;
            gap:8px;
            margin-top:6px;
            align-items:center;
        }

        .buttons-row-main {
            display:flex;
            flex-wrap:wrap;
            gap:8px;
            margin-top:10px;
        }

        .btn-primary {
            border-radius:999px;
            padding:9px 16px;
            border:none;
            cursor:pointer;
            background:linear-gradient(135deg,var(--primary),var(--primary-light));
            color:white;
            font-size:13px;
        }

        .btn-danger {
            border-radius:999px;
            padding:9px 16px;
            border:none;
            cursor:pointer;
            background:linear-gradient(135deg,#b91c1c,#ef4444);
            color:white;
            font-size:13px;
        }

        .btn-icon {
            width:38px;
            height:38px;
            border-radius:999px;
            border:1px solid var(--border-subtle);
            background:var(--bg-card);
            display:flex;
            align-items:center;
            justify-content:center;
            cursor:pointer;
            font-size:18px;
        }

        body.light .btn-icon {
            background:#ffffff;
        }

        .btn-icon.off {
            border-color:#f97373;
            color:#fecaca;
        }

        .hint {
            margin-top:6px;
            font-size:12px;
            color:var(--text-muted);
        }

        .hint span {
            color:var(--primary-light);
        }

        /* ===== CHAT ===== */
        .chat-header {
            font-size:13px;
            margin-bottom:4px;
        }

        .chat-messages {
            max-height:190px;
            border-radius:10px;
            border:1px solid var(--border-subtle);
            background:rgba(15,23,42,0.7);
            padding:8px;
            overflow-y:auto;
            font-size:12px;
        }

        body.light .chat-messages {
            background:#f9fafb;
        }

        .chat-msg {
            margin-bottom:4px;
            display:flex;
            flex-direction:column;
        }

        .chat-meta {
            font-size:10px;
            color:var(--text-muted);
        }

        .chat-text {
            padding:4px 8px;
            border-radius:8px;
            margin-top:1px;
            max-width:100%;
            word-wrap:break-word;
        }

        .chat-msg.self .chat-text {
            align-self:flex-end;
            background:linear-gradient(135deg,var(--primary),var(--primary-light));
            color:white;
        }

        .chat-msg.other .chat-text {
            align-self:flex-start;
            background:rgba(15,23,42,0.9);
        }

        body.light .chat-msg.other .chat-text {
            background:#e5e7eb;
            color:#0f172a;
        }

        .chat-msg.system .chat-text {
            align-self:center;
            background:transparent;
            color:var(--text-muted);
            font-size:11px;
            padding:0;
        }

        .chat-input-row {
            margin-top:6px;
            display:flex;
            gap:6px;
            align-items:center;
        }

        .chat-input-row input {
            flex:1;
            padding:7px 9px;
            border-radius:8px;
            border:1px solid var(--border-subtle);
            background:rgba(15,23,42,0.85);
            color:var(--text-main);
            font-size:12px;
            outline:none;
        }

        body.light .chat-input-row input {
            background:#ffffff;
            color:#0f172a;
        }

        .chat-input-row button.chat-send-btn {
            border-radius:999px;
            padding:7px 14px;
            border:none;
            cursor:pointer;
            background:linear-gradient(135deg,var(--primary),var(--primary-light));
            color:white;
            font-size:12px;
            white-space:nowrap;
        }

        .chat-attach-btn {
            width:32px;
            height:32px;
            font-size:16px;
        }

        .chat-file-hint {
            margin-top:4px;
            font-size:10px;
            color:var(--text-muted);
        }

        .footer {
            margin-top:26px;
            text-align:center;
            font-size:12px;
            color:var(--text-muted);
        }

        .footer span {
            color:var(--primary-light);
        }
    </style>
</head>
<body class="dark">

<script>
    // Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø©
    (function guard() {
        const user = JSON.parse(localStorage.getItem("ghasiq_user") || "null");
        if (!user || !user.login) {
            window.location.href = "login.html";
        }
        window.__gh_user = user;
    })();
</script>

<div class="page">

    <!-- NAVBAR -->
    <header class="navbar">
        <div class="navbar-left">
            <a href="index.html">
                <img src="logo.png" alt="GHASIQ Logo" class="logo" />
            </a>

            <nav class="nav-links">
                <a href="index.html#about" data-i18n="nav_about">Ø¹Ù† Ghasiq</a>
                <a href="services.html" data-i18n="nav_services">Ø§Ù„Ø®Ø¯Ù…Ø§Øª</a>
                <a href="call-system.html" class="active" data-i18n="nav_call_system">Ù†Ø¸Ø§Ù… Ø§Ù„Ø§ØªØµØ§Ù„</a>
                <a href="notifications.html" data-i18n="nav_notifications">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</a>
            </nav>

        </div>

        <div class="nav-actions">
            <span id="userChip" class="user-chip">User</span>

            <button class="btn-toggle-theme" id="langToggle" type="button">
                <span id="langLabel">AR</span>
            </button>

            <button class="btn-toggle-theme" id="themeToggle" type="button">
                <span id="themeLabel">Dark</span>
                <span id="themeIcon">â˜¾</span>
            </button>

            <button class="btn-logout" type="button" onclick="logout()" data-i18n="btn_logout">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
    </header>

    <section class="call-layout">
        <!-- SIDEBAR -->
        <aside class="controls-box">
            <div class="call-header sidebar-header">
                <div class="call-header-title" data-i18n="call_title_ctrl">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§ØªØµØ§Ù„</div>
                <div class="call-header-sub" data-i18n="call_sub_ctrl">
                    ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù Ø«Ø§Ø¨Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¯ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. Ø§ÙƒØªØ¨ Ù…Ø¹Ø±Ù‘Ù Ø£ÙŠ Ù…ÙˆØ¸Ù ÙˆØ§Ø¶ØºØ· "Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„" Ù„ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„ØºØ±ÙØ©ØŒ
                    ÙˆØ§Ù„Ù†Ø¸Ø§Ù… ÙŠØ­Ø§ÙˆÙ„ ØªÙˆØµÙŠÙ„Ù‡ Ø¨Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
                </div>
            </div>

            <div class="sidebar-section">
                <div class="id-row">
                    <div style="font-size:13px; margin-bottom:4px;" data-i18n="label_my_id">Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:</div>
                    <div id="myIdBox" class="my-id">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>

                <div class="remote-input-row">
                    <label style="font-size:13px;" data-i18n="label_remote_id">Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø¶Ø§ÙØªÙ‡:</label>
                    <input id="remoteIdInput"
                           type="text"
                           data-i18n-placeholder="remote_id_placeholder"
                           placeholder="Ù…Ø«Ø§Ù„: GHASIQ-IT-HEAD Ø£Ùˆ GHASIQ-HR-HEAD">
                    <small class="hint">
                        ÙƒÙ„ Ù…Ø§ ØªØ¶ÙŠÙ ID Ø¬Ø¯ÙŠØ¯ ÙˆØªØ¶ØºØ· "Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„" Ù‡ÙŠÙ†Ø¶Ù… Ù„Ù„ØºØ±ÙØ© (Ù„Ùˆ ÙØ§ØªØ­ Ø§Ù„ØµÙØ­Ø©) ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ ÙŠØ³Ù…Ø¹Ù‡ ÙˆÙŠØ´ÙˆÙÙ‡.
                    </small>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="buttons-row">
                    <button type="button" id="btnToggleCamera" class="btn-icon" title="ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§">ğŸ¥</button>
                    <button type="button" id="btnToggleMic" class="btn-icon" title="ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§ÙŠÙƒ">ğŸ™ï¸</button>
                    <button type="button" id="btnShareScreen" class="btn-icon" title="Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©">ğŸ–¥ï¸</button>
                    <!-- Ù…ÙŠÙˆØª Ù„Ù„Ø¬Ù…ÙŠØ¹ (Ø§Ø¯Ù…Ù† ÙÙ‚Ø· ÙÙŠ Ø§Ù„ÙƒÙˆØ¯) -->
                    <button type="button" id="btnMuteAll" class="btn-icon" title="ÙƒØªÙ… Ø§Ù„Ø¬Ù…ÙŠØ¹">ğŸ”‡</button>
                </div>

                <div class="buttons-row buttons-row-main">
                    <button class="btn-primary" id="btnStartCall" data-i18n="btn_start_call">Ø¨Ø¯Ø¡ / Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø§Ø±Ùƒ</button>
                    <button class="btn-danger" id="btnEndCall" data-i18n="btn_end_call">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©</button>
                </div>
            </div>

            <!-- CHAT -->
            <div class="sidebar-section">
                <div class="chat-header">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹</div>
                <div id="chatMessages" class="chat-messages"></div>
                <div class="chat-input-row">
                    <button type="button"
                            id="btnAttachFile"
                            class="btn-icon chat-attach-btn"
                            title="Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ù">ğŸ“</button>
                    <input id="chatInput" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø¶ØºØ· Ø¥Ø±Ø³Ø§Ù„ Ø£Ùˆ Enter">
                    <button type="button"
                            id="btnSendChat"
                            class="chat-send-btn">Ø¥Ø±Ø³Ø§Ù„</button>
                    <input id="chatFileInput" type="file" style="display:none" />
                </div>
                <div class="chat-file-hint">
                    âš  ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„ÙØ§Øª ØµØºÙŠØ±Ø© (Ø­ØªÙ‰ Ø­ÙˆØ§Ù„ÙŠ 2MB) Ù„ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ù…Ù† Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†.
                </div>
            </div>

            <div class="sidebar-section sidebar-hint">
                <div class="hint" data-i18n="hint_text">
                    â€¢ ØªØ£ÙƒØ¯ Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ÙØªØ­ÙˆØ§ Ù†ÙØ³ ØµÙØ­Ø© Ø§Ù„Ø§ØªØµØ§Ù„.<br>
                    â€¢ Ù„ÙƒÙ„ Ø±Ø¦ÙŠØ³ Ù‚Ø³Ù… Ù…Ø¹Ø±Ù Ø«Ø§Ø¨ØªØŒ Ù…Ø«Ù„:
                    <span>GHASIQ-IT-HEAD</span>ØŒ <span>GHASIQ-HR-HEAD</span>ØŒ <span>GHASIQ-FINANCE-HEAD</span>ØŒ <span>GHASIQ-GM</span>.<br>
                    â€¢ Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø§Ø±Ùƒ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø£ÙŠ Ø¬Ù‡Ø§Ø²ØŒ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ­Ø§ÙˆÙ„ ØªÙˆØµÙŠÙ„Ù‡ Ø¨ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
                </div>
            </div>
        </aside>

        <!-- MAIN -->
        <div class="call-card">
            <div class="call-header">
                <div class="call-header-title" data-i18n="call_title_main">ØºØ±ÙØ© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
                <div class="call-header-sub" data-i18n="call_sub_main">
                    Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ© Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹Ø© Ø¨ÙŠÙ† Ø£Ù‚Ø³Ø§Ù… Ghasiq
                    (Ø§Ù„ØªØ´ØºÙŠÙ„ØŒ Ø§Ù„ØµÙŠØ§Ù†Ø©ØŒ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©ØŒ Ø§Ù„Ù…Ø§Ù„ÙŠØ©ØŒ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©).
                </div>
            </div>

            <div class="video-grid">
                <div class="video-box">
                    <div class="video-label" data-i18n="video_label_local">Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</div>
                    <div class="video-inner">
                        <video id="localVideo" autoplay muted playsinline></video>
                        <button type="button" class="fullscreen-btn" data-fullscreen-target="local">â›¶</button>
                    </div>
                </div>
                <div class="video-box">
                    <div class="video-label" data-i18n="video_label_remote">Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ† Ø§Ù„Ø¢Ø®Ø±ÙˆÙ†</div>
                    <div id="remoteVideosGrid" class="remote-grid"></div>
                </div>
            </div>

            <div class="status-bar">
                <span data-i18n="status_prefix">Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„:</span>
                <span id="callStatus" class="status-green" data-i18n="status_ready">Ø¬Ø§Ù‡Ø² Ù„Ø¨Ø¯Ø¡ Ù…ÙƒØ§Ù„Ù…Ø©</span>

                <span class="status-timer-label">| Ù…Ø¯Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©:</span>
                <span id="callTimer" class="status-timer">00:00</span>

                <span class="status-participants-label">| Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†:</span>
                <span id="participantsCount" class="status-participants">1</span>
            </div>
        </div>
    </section>

    <footer class="footer" data-i18n="footer_text">
        Â© <span>Ghasiq</span> Logistical Support & Operations â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.
    </footer>
</div>

<script>
    // ===== Theme =====
    const bodyEl = document.body;
    const themeToggle = document.getElementById("themeToggle");
    const themeLabel = document.getElementById("themeLabel");
    const themeIcon = document.getElementById("themeIcon");

    function applyTheme(mode) {
        if (mode === "light") {
            bodyEl.classList.add("light");
            bodyEl.classList.remove("dark");
            themeLabel.textContent = "Light";
            themeIcon.textContent = "â˜€";
        } else {
            bodyEl.classList.add("dark");
            bodyEl.classList.remove("light");
            themeLabel.textContent = "Dark";
            themeIcon.textContent = "â˜¾";
        }
        localStorage.setItem("ghasiq_theme", mode);
    }

    function initTheme() {
        const saved = localStorage.getItem("ghasiq_theme") || "dark";
        applyTheme(saved);
    }

    themeToggle.addEventListener("click", () => {
        const isLight = bodyEl.classList.contains("light");
        applyTheme(isLight ? "dark" : "light");
    });

    initTheme();

    // Ø¹Ø±Ø¶ Ø§Ù„ÙŠÙˆØ²Ø±
    (function showUser() {
        const chip = document.getElementById("userChip");
        const user = window.__gh_user;
        if (!user) return;
        chip.textContent = `${user.username} (${user.role})`;
    })();

    function logout() {
        localStorage.removeItem("ghasiq_user");
        window.location.href = "login.html";
    }

    function getCurrentLang() {
        return localStorage.getItem("ghasiq_lang") || "ar";
    }

    // ===== Ù†ØµÙˆØµ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© =====
    const callTexts = {
        ar: {
            ready: "Ø¬Ø§Ù‡Ø² Ù„Ø¨Ø¯Ø¡ Ù…ÙƒØ§Ù„Ù…Ø©",
            peer_error: "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù… PeerJS. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.",
            incoming_call: "ÙŠØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ù…ÙƒØ§Ù„Ù…Ø©...",
            media_error: "ØªØ¹Ø°Ø± ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§/Ø§Ù„Ù…Ø§ÙŠÙƒ.",
            call_active: "Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ù†Ø´Ø·Ø©",
            call_closed: "ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©",
            call_error: "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©",
            call_ended_ready: "ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©. Ø¬Ø§Ù‡Ø² Ù„Ø§ØªØµØ§Ù„ Ø¬Ø¯ÙŠØ¯.",
            alert_remote_required: "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø¶Ø§ÙØªÙ‡.",
            media_error_onload: "ØªØ¹Ø°Ø± ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§/Ø§Ù„Ù…Ø§ÙŠÙƒ. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­.",
            muted_by_all: "ØªÙ… ÙƒØªÙ… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ø¹Ù†Ø¯Ùƒ Ø¨ÙˆØ§Ø³Ø·Ø© Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„ØºØ±ÙØ©.",
            mute_admin_only: "ÙÙ‚Ø· Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ø¯Ù…Ù† ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒØªÙ… Ø§Ù„Ø¬Ù…ÙŠØ¹.",
            file_too_big: "Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ±ØŒ Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ 2 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª.",
            file_sent_label: "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ù:",
            file_received_label: "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù„Ù:"
        },
        en: {
            ready: "Ready to start a call",
            peer_error: "Error connecting to PeerJS server. Please check your internet connection.",
            incoming_call: "Incoming call...",
            media_error: "Unable to access camera/microphone.",
            call_active: "Call is active",
            call_closed: "Call ended",
            call_error: "An error occurred during the call",
            call_ended_ready: "Call ended. Ready for a new call.",
            alert_remote_required: "Please enter the participant ID.",
            media_error_onload: "Unable to access camera/microphone. Please allow access in the browser.",
            muted_by_all: "Your microphone was muted by the room controller.",
            mute_admin_only: "Only admin account can use mute all.",
            file_too_big: "File is too large. Max allowed is about 2MB.",
            file_sent_label: "File sent:",
            file_received_label: "File received:"
        }
    };

    function trCall(key) {
        const lang = getCurrentLang();
        const dict = callTexts[lang] || {};
        return dict[key] || key;
    }

    // ===== Fullscreen helper =====
    function toggleFullscreen(element) {
        if (!element) return;
        if (!document.fullscreenElement) {
            if (element.requestFullscreen) {
                element.requestFullscreen().catch(err => console.error('FS error', err));
            }
        } else {
            document.exitFullscreen().catch(() => {});
        }
    }

    // ===== PeerJS / Mesh Room Logic =====
    const user = window.__gh_user || { role: "User" };

    function normalizeRole(r) {
        if (!r) return "USER";
        return r.replace(/\s+/g, "-").toUpperCase();
    }

    function isCurrentUserAdmin() {
        if (!user || !user.role) return false;
        return user.role.toLowerCase().includes("admin"); // role = "Admin"
    }

    const baseRole = normalizeRole(user.role);
    const myPeerId = "GHASIQ-" + baseRole;

    const myIdBox = document.getElementById("myIdBox");
    const remoteIdInput = document.getElementById("remoteIdInput");
    const localVideo = document.getElementById("localVideo");
    const remoteVideosGrid = document.getElementById("remoteVideosGrid");
    const callStatus = document.getElementById("callStatus");
    const btnStartCall = document.getElementById("btnStartCall");
    const btnEndCall = document.getElementById("btnEndCall");
    const btnToggleCamera = document.getElementById("btnToggleCamera");
    const btnToggleMic = document.getElementById("btnToggleMic");
    const btnShareScreen = document.getElementById("btnShareScreen");
    const btnMuteAll = document.getElementById("btnMuteAll");
    const callTimerEl = document.getElementById("callTimer");
    const participantsCountEl = document.getElementById("participantsCount");

    // Chat elements
    const chatMessagesEl = document.getElementById("chatMessages");
    const chatInputEl = document.getElementById("chatInput");
    const btnSendChat = document.getElementById("btnSendChat");
    const btnAttachFile = document.getElementById("btnAttachFile");
    const chatFileInput = document.getElementById("chatFileInput");

    // local fullscreen button
    const localFsBtn = document.querySelector('[data-fullscreen-target="local"]');
    if (localFsBtn) {
        localFsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleFullscreen(localVideo);
        });
    }

    let peer = null;
    let cameraStream = null;
    let localStream = null;

    const activeCalls = {};
    const dataConnections = {};

    let isCameraOn = true;
    let isMicOn = true;
    let isScreenSharing = false;

    let callTimerInterval = null;
    let callSecondsElapsed = 0;
    let callInProgress = false;

    function setStatus(textKey, isError) {
        const text = trCall(textKey);
        callStatus.textContent = text;
        callStatus.classList.toggle("status-green", !isError);
        callStatus.style.color = isError ? "#f97373" : "#22c55e";
    }

    function updateParticipantsCount() {
        const count = 1 + Object.keys(activeCalls).length;
        participantsCountEl.textContent = count;
    }

    function updateCameraButtonUI() {
        btnToggleCamera.classList.toggle("off", !isCameraOn);
        btnToggleCamera.textContent = isCameraOn ? "ğŸ¥" : "ğŸš«";
    }

    function updateMicButtonUI() {
        btnToggleMic.classList.toggle("off", !isMicOn);
        btnToggleMic.textContent = isMicOn ? "ğŸ™ï¸" : "ğŸ”‡";
    }

    function formatTime(totalSeconds) {
        const m = Math.floor(totalSeconds / 60);
        const s = totalSeconds % 60;
        const mm = m < 10 ? "0" + m : "" + m;
        const ss = s < 10 ? "0" + s : "" + s;
        return mm + ":" + ss;
    }

    function startCallTimer() {
        if (callInProgress) return;
        callInProgress = true;
        callSecondsElapsed = 0;
        if (callTimerInterval) clearInterval(callTimerInterval);
        callTimerEl.textContent = "00:00";
        callTimerInterval = setInterval(() => {
            callSecondsElapsed++;
            callTimerEl.textContent = formatTime(callSecondsElapsed);
        }, 1000);
    }

    function stopCallTimer(resetToZero = true) {
        callInProgress = false;
        if (callTimerInterval) {
            clearInterval(callTimerInterval);
            callTimerInterval = null;
        }
        if (resetToZero) {
            callSecondsElapsed = 0;
            callTimerEl.textContent = "00:00";
        }
    }

    function switchVideoTrack(newStream) {
        if (!newStream) return;
        localStream = newStream;
        localVideo.srcObject = newStream;

        const newTrack = newStream.getVideoTracks()[0];
        if (!newTrack) return;

        Object.values(activeCalls).forEach(call => {
            if (!call.peerConnection) return;
            const sender = call.peerConnection.getSenders()
                .find(s => s.track && s.track.kind === 'video');
            if (sender) {
                sender.replaceTrack(newTrack).catch(err => console.error('replaceTrack error', err));
            }
        });
    }

    function startScreenShare() {
        if (isScreenSharing) return;

        navigator.mediaDevices.getDisplayMedia({ video: true, audio: false })
            .then(screenStream => {
                isScreenSharing = true;
                btnShareScreen.classList.add('off');
                btnShareScreen.textContent = 'ğŸ›‘';

                const screenTrack = screenStream.getVideoTracks()[0];
                screenTrack.addEventListener('ended', () => {
                    stopScreenShare();
                });

                switchVideoTrack(screenStream);
            })
            .catch(err => {
                console.error('getDisplayMedia error', err);
            });
    }

    function stopScreenShare() {
        if (!isScreenSharing) return;

        isScreenSharing = false;
        btnShareScreen.classList.remove('off');
        btnShareScreen.textContent = 'ğŸ–¥ï¸';

        if (localStream && localStream !== cameraStream) {
            localStream.getTracks().forEach(t => t.stop());
        }

        if (cameraStream) {
            switchVideoTrack(cameraStream);
        }
    }

    function getMediaStream() {
        if (cameraStream) {
            localStream = cameraStream;
            localVideo.srcObject = localStream;
            return Promise.resolve(localStream);
        }

        return navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then((stream) => {
                cameraStream = stream;
                localStream = stream;

                isCameraOn = true;
                isMicOn = true;
                stream.getVideoTracks().forEach(t => t.enabled = true);
                stream.getAudioTracks().forEach(t => t.enabled = true);
                updateCameraButtonUI();
                updateMicButtonUI();

                localVideo.srcObject = stream;
                return stream;
            });
    }

    function addRemoteVideo(peerId, remoteStream) {
        let wrapper = document.querySelector(`.remote-video-wrapper[data-peer-id="${peerId}"]`);
        if (!wrapper) {
            wrapper = document.createElement('div');
            wrapper.className = 'remote-video-wrapper';
            wrapper.dataset.peerId = peerId;

            const v = document.createElement('video');
            v.autoplay = true;
            v.playsInline = true;
            v.id = `vid-${peerId}`;
            v.srcObject = remoteStream;

            const label = document.createElement('div');
            label.className = 'remote-peer-label';
            label.textContent = peerId;

            const btnFs = document.createElement('button');
            btnFs.type = 'button';
            btnFs.className = 'fullscreen-btn';
            btnFs.textContent = 'â›¶';
            btnFs.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFullscreen(v);
            });

            wrapper.appendChild(v);
            wrapper.appendChild(label);
            wrapper.appendChild(btnFs);
            remoteVideosGrid.appendChild(wrapper);
        } else {
            const v = wrapper.querySelector('video');
            if (v) v.srcObject = remoteStream;
        }
        updateParticipantsCount();
    }

    function removeRemoteVideo(peerId) {
        const wrapper = document.querySelector(`.remote-video-wrapper[data-peer-id="${peerId}"]`);
        if (wrapper && wrapper.parentNode) {
            const vid = wrapper.querySelector('video');
            if (vid && vid.srcObject) {
                vid.srcObject.getTracks().forEach(t => t.stop());
            }
            wrapper.parentNode.removeChild(wrapper);
        }
        updateParticipantsCount();
    }

    function bindCallEvents(call) {
        const peerId = call.peer;
        activeCalls[peerId] = call;
        setStatus("call_active", false);
        startCallTimer();
        updateParticipantsCount();

        call.on("stream", (remoteStream) => {
            addRemoteVideo(peerId, remoteStream);
        });

        call.on("close", () => {
            removeRemoteVideo(peerId);
            delete activeCalls[peerId];
            if (Object.keys(activeCalls).length === 0) {
                stopCallTimer(false); // ØªØ³ÙŠØ¨ Ø§Ù„ØªØ§ÙŠÙ…Ø± Ø¢Ø®Ø± Ù‚ÙŠÙ…Ø© Ù„Ùˆ Ø§Ù†Øª Ù„Ø³Ù‡ ÙØ§ØªØ­
                setStatus("call_closed", true);
            }
        });

        call.on("error", () => {
            setStatus("call_error", true);
        });
    }

    // ===== CHAT (Text + Files) =====
    function appendChatMessage(from, text, type) {
        if (!text) return;

        const msgDiv = document.createElement('div');
        msgDiv.classList.add('chat-msg');
        if (type === 'system') {
            msgDiv.classList.add('system');
        } else if (type === 'self') {
            msgDiv.classList.add('self');
        } else {
            msgDiv.classList.add('other');
        }

        if (type !== 'system') {
            const meta = document.createElement('div');
            meta.className = 'chat-meta';
            meta.textContent = type === 'self' ? 'Ø£Ù†Øª' : from;
            msgDiv.appendChild(meta);
        }

        const textDiv = document.createElement('div');
        textDiv.className = 'chat-text';
        textDiv.textContent = text;

        msgDiv.appendChild(textDiv);
        chatMessagesEl.appendChild(msgDiv);
        chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    function appendFileMessage(from, fileName, dataUrl, isSelf, isIncoming) {
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('chat-msg');
        msgDiv.classList.add(isSelf ? 'self' : 'other');

        const meta = document.createElement('div');
        meta.className = 'chat-meta';
        meta.textContent = isSelf ? 'Ø£Ù†Øª' : from;
        msgDiv.appendChild(meta);

        const textDiv = document.createElement('div');
        textDiv.className = 'chat-text';

        const labelSpan = document.createElement('span');
        labelSpan.textContent = isIncoming
            ? trCall("file_received_label") + " "
            : trCall("file_sent_label") + " ";
        textDiv.appendChild(labelSpan);

        const iconSpan = document.createElement('span');
        iconSpan.textContent = "ğŸ“ ";
        textDiv.appendChild(iconSpan);

        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = fileName || "file";
        link.textContent = fileName || "Ù…Ù„Ù";
        link.style.textDecoration = "underline";
        link.style.marginInlineStart = "4px";

        textDiv.appendChild(link);

        msgDiv.appendChild(textDiv);
        chatMessagesEl.appendChild(msgDiv);
        chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    function sendChatMessage() {
        const text = chatInputEl.value.trim();
        if (!text) return;
        chatInputEl.value = "";

        appendChatMessage(myPeerId, text, "self");

        Object.values(dataConnections).forEach(conn => {
            if (conn && conn.open) {
                try {
                    conn.send({ type: "chat", from: myPeerId, text });
                } catch (e) {}
            }
        });
    }

    function broadcastFile(fileName, mimeType, dataUrl) {
        Object.values(dataConnections).forEach(conn => {
            if (conn && conn.open) {
                try {
                    conn.send({
                        type: "file",
                        from: myPeerId,
                        fileName,
                        mimeType,
                        dataUrl
                    });
                } catch (e) {}
            }
        });
    }

    function handleFileSelected() {
        const file = chatFileInput.files && chatFileInput.files[0];
        if (!file) return;

        const maxSize = 2 * 1024 * 1024; // ~2MB
        if (file.size > maxSize) {
            appendChatMessage("Ø§Ù„Ù†Ø¸Ø§Ù…", trCall("file_too_big"), "system");
            chatFileInput.value = "";
            return;
        }

        const reader = new FileReader();
        reader.onload = function (ev) {
            const dataUrl = ev.target.result;
            broadcastFile(file.name, file.type || "application/octet-stream", dataUrl);
            appendFileMessage(myPeerId, file.name, dataUrl, true, false);
            chatFileInput.value = "";
        };
        reader.readAsDataURL(file);
    }

    btnSendChat.addEventListener("click", sendChatMessage);
    chatInputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            sendChatMessage();
        }
    });

    if (btnAttachFile && chatFileInput) {
        btnAttachFile.addEventListener("click", () => {
            chatFileInput.click();
        });

        chatFileInput.addEventListener("change", handleFileSelected);
    }

    // ===== Mic helper for local & force mute =====
    function setMicState(on) {
        const stream = cameraStream || localStream;
        if (!stream) return;
        const tracks = stream.getAudioTracks();
        if (!tracks || tracks.length === 0) return;
        isMicOn = on;
        tracks.forEach(t => t.enabled = isMicOn);
        updateMicButtonUI();
    }

    // ===== Data Messages =====
    function handleDataMessage(fromPeerId, msg) {
        if (!msg || typeof msg !== "object") return;

        if (msg.type === "initPeers") {
            const peers = msg.peers || [];
            peers.forEach(pid => {
                if (pid && pid !== myPeerId) {
                    startCallToPeer(pid);
                }
            });
        }

        if (msg.type === "newPeer") {
            const pid = msg.peerId;
            if (pid && pid !== myPeerId) {
                startCallToPeer(pid);
            }
        }

        if (msg.type === "chat") {
            appendChatMessage(msg.from || fromPeerId, msg.text, "other");
        }

        if (msg.type === "file") {
            if (msg.dataUrl && msg.fileName) {
                appendFileMessage(
                    msg.from || fromPeerId,
                    msg.fileName,
                    msg.dataUrl,
                    false,
                    true
                );
            }
        }

        if (msg.type === "forceMute") {
            setMicState(false);
            appendChatMessage("Ø§Ù„Ù†Ø¸Ø§Ù…", trCall("muted_by_all"), "system");
        }
    }

    function ensureDataConnection(peerId) {
        if (peerId === myPeerId) return null;
        let conn = dataConnections[peerId];
        if (conn) return conn;

        conn = peer.connect(peerId);
        conn.on('data', (msg) => handleDataMessage(peerId, msg));
        conn.on('close', () => { delete dataConnections[peerId]; });
        conn.on('error', () => {});
        conn.on('open', () => {
            dataConnections[peerId] = conn;
        });

        return conn;
    }

    function broadcastNewPeer(newPeerId) {
        Object.entries(dataConnections).forEach(([pid, conn]) => {
            if (!conn || !conn.open) return;
            if (pid === newPeerId) return;
            try {
                conn.send({ type: "newPeer", peerId: newPeerId });
            } catch (e) {}
        });
    }

    function startCallToPeer(peerId) {
        if (!peerId || peerId === myPeerId) return;
        if (activeCalls[peerId]) return;

        getMediaStream().then((stream) => {
            const call = peer.call(peerId, stream);
            bindCallEvents(call);
            ensureDataConnection(peerId);
        }).catch(err => {
            console.error(err);
            setStatus("media_error", true);
        });
    }

    function addParticipantById(remoteId) {
        if (!remoteId || remoteId === myPeerId) return;

        getMediaStream().then((stream) => {
            if (!activeCalls[remoteId]) {
                const call = peer.call(remoteId, stream);
                bindCallEvents(call);
            }

            const existingPeers = [myPeerId, ...Object.keys(activeCalls).filter(id => id !== remoteId)];

            let conn = ensureDataConnection(remoteId);
            if (!conn) return;

            const sendInitAndBroadcast = () => {
                try {
                    conn.send({ type: "initPeers", peers: existingPeers });
                } catch (e) {}
                broadcastNewPeer(remoteId);
            };

            if (conn.open) {
                sendInitAndBroadcast();
            } else {
                conn.on('open', () => {
                    dataConnections[remoteId] = conn;
                    sendInitAndBroadcast();
                });
            }
        }).catch(err => {
            console.error(err);
            setStatus("media_error", true);
        });
    }

    function initPeer() {
        peer = new Peer(myPeerId, { debug: 1 });

        peer.on("open", (id) => {
            myIdBox.textContent = id;
            setStatus("ready", false);
        });

        peer.on("error", (err) => {
            console.error(err);
            setStatus("peer_error", true);
        });

        peer.on("call", (call) => {
            setStatus("incoming_call", false);
            getMediaStream().then((stream) => {
                call.answer(stream);
                bindCallEvents(call);
                ensureDataConnection(call.peer);
            }).catch((err) => {
                console.error(err);
                setStatus("media_error", true);
            });
        });

        peer.on("connection", (conn) => {
            const pid = conn.peer;
            dataConnections[pid] = conn;
            conn.on('data', (msg) => handleDataMessage(pid, msg));
            conn.on('close', () => { delete dataConnections[pid]; });
            conn.on('error', () => {});
        });
    }

    // ÙƒØ§Ù…ÙŠØ±Ø§
    btnToggleCamera.addEventListener("click", () => {
        if (isScreenSharing) {
            alert("Ø£ÙˆÙ‚Ù Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø© Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.");
            return;
        }
        const stream = cameraStream || localStream;
        if (!stream) return;

        const tracks = stream.getVideoTracks();
        if (!tracks || tracks.length === 0) return;

        isCameraOn = !isCameraOn;
        tracks.forEach(t => t.enabled = isCameraOn);
        updateCameraButtonUI();
    });

    // Ù…Ø§ÙŠÙƒ (Ù„ÙˆØ­Ø¯Ùƒ)
    btnToggleMic.addEventListener("click", () => {
        setMicState(!isMicOn);
    });

    // Ù…ÙŠÙˆØª Ù„Ù„Ø¬Ù…ÙŠØ¹ (Ø§Ø¯Ù…Ù† ÙÙ‚Ø·)
    btnMuteAll.addEventListener("click", () => {
        if (!isCurrentUserAdmin()) {
            appendChatMessage("Ø§Ù„Ù†Ø¸Ø§Ù…", trCall("mute_admin_only"), "system");
            return;
        }

        // ÙƒØªÙ… Ù†ÙØ³Ùƒ
        setMicState(false);

        // Ø¨Ø¹Øª Ø£Ù…Ø± Ù„Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ÙŠÙƒØªÙ…ÙˆØ§ Ù†ÙØ³Ù‡Ù…
        Object.values(dataConnections).forEach(conn => {
            if (conn && conn.open) {
                try {
                    conn.send({ type: "forceMute" });
                } catch (e) {}
            }
        });

        appendChatMessage("Ø§Ù„Ù†Ø¸Ø§Ù…", "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± ÙƒØªÙ… Ù„Ù„Ø¬Ù…ÙŠØ¹.", "system");
    });

    // Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©
    btnShareScreen.addEventListener("click", () => {
        if (isScreenSharing) {
            stopScreenShare();
        } else {
            startScreenShare();
        }
    });

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø§Ø±Ùƒ Ø¬Ø¯ÙŠØ¯
    btnStartCall.addEventListener("click", () => {
        const remoteId = remoteIdInput.value.trim();
        if (!remoteId) {
            alert(trCall("alert_remote_required"));
            return;
        }
        setStatus("incoming_call", false);
        addParticipantById(remoteId);
    });

    // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© (Ø§Ù†Øª Ø¨Ø³)
    btnEndCall.addEventListener("click", () => {
        // Ø§Ù†Øª Ø¨ØªÙ‚ÙÙ„ ÙƒÙ„ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ù…Ù† Ø·Ø±ÙÙƒ
        Object.values(activeCalls).forEach(call => {
            try { call.close(); } catch (e) {}
        });
        for (const k in activeCalls) delete activeCalls[k];

        // ØªÙ‚ÙÙ„ Ø§Ù„Ù€ data connections Ù…Ù† Ø·Ø±ÙÙƒ Ø¨Ø±Ø¶Ù‡
        Object.values(dataConnections).forEach(conn => {
            try { conn.close(); } catch (e) {}
        });
        for (const k in dataConnections) delete dataConnections[k];

        // ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ø±ÙŠÙ…ÙˆØª Ø¹Ù†Ø¯Ùƒ Ø¨Ø³
        remoteVideosGrid.querySelectorAll('.remote-video-wrapper').forEach(w => {
            const vid = w.querySelector('video');
            if (vid && vid.srcObject) {
                vid.srcObject.getTracks().forEach(t => t.stop());
            }
            w.remove();
        });

        // Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¨ØªØ§Ø¹ØªÙƒ
        stopScreenShare();

        if (cameraStream) {
            cameraStream.getTracks().forEach(t => t.stop());
            cameraStream = null;
        }
        localStream = null;
        localVideo.srcObject = null;

        isCameraOn = true;
        isMicOn = true;
        updateCameraButtonUI();
        updateMicButtonUI();

        stopCallTimer();
        updateParticipantsCount();
        setStatus("call_ended_ready", false);
        appendChatMessage("Ø§Ù„Ù†Ø¸Ø§Ù…", "Ù„Ù‚Ø¯ ØºØ§Ø¯Ø±Øª Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©. Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† Ù…Ø³ØªÙ…Ø±ÙŠÙ† Ù„ÙˆØ­Ø¯Ù‡Ù….", "system");
    });

    initPeer();

    window.addEventListener('load', () => {
        getMediaStream().catch(err => {
            console.error(err);
            setStatus("media_error_onload", true);
        });

        // Ù„Ùˆ Ù…Ø´ Ø§Ø¯Ù…Ù†ØŒ Ø®Ù„ÙŠÙ‡ Ø¨Ø§ÙŠÙ† Ø¥Ù†Ù‡ Ù…Ø­Ø¯ÙˆØ¯
        if (!isCurrentUserAdmin()) {
            btnMuteAll.style.opacity = "0.6";
            btnMuteAll.style.cursor = "not-allowed";
            btnMuteAll.title = trCall("mute_admin_only");
        }
    });
</script>

<script>
    // ========== ØªØ±Ø¬Ù…Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ© ==========
    const translations = {
        ar: {},
        en: {
            page_title: "Ghasiq - Internal Call System",
            nav_about: "About Ghasiq",
            nav_services: "Services",
            nav_call_system: "Call System",
            nav_notifications: "Notifications",
            btn_logout: "Log out",

            call_title_main: "Internal call room for employees",
            call_sub_main: "Use this room for quick operational meetings between Ghasiq departments (operations, maintenance, HR, finance, general management).",

            video_label_local: "Your video",
            video_label_remote: "Other participants",

            status_prefix: "Call status:",
            status_ready: "Ready to start a call",

            call_title_ctrl: "Call management",
            call_sub_ctrl: "A fixed ID is generated based on the user's role. Type any employee ID and press 'Start' to add them to the room. The system will try to connect them with all other participants.",

            label_my_id: "Your ID:",
            label_remote_id: "Participant ID to add:",
            remote_id_placeholder: "Example: GHASIQ-IT-HEAD or GHASIQ-HR-HEAD",

            btn_start_call: "Start / Add participant",
            btn_end_call: "End call",

            hint_text: "â€¢ Make sure all participants open the same call page.<br>â€¢ Each department head has a fixed ID such as: <span>GHASIQ-IT-HEAD</span>, <span>GHASIQ-HR-HEAD</span>, <span>GHASIQ-FINANCE-HEAD</span>, <span>GHASIQ-GM</span>.<br>â€¢ When a new participant is added from any device, the system will try to connect them automatically to all existing participants.",

            footer_text: "Â© <span>Ghasiq</span> Logistical Support & Operations â€” All rights reserved."
        }
    };

    function initArabicFromDom() {
        document.querySelectorAll("[data-i18n]").forEach(el => {
            const key = el.getAttribute("data-i18n");
            if (!translations.ar[key]) {
                translations.ar[key] = el.innerHTML;
            }
        });

        document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
            const key = el.getAttribute("data-i18n-placeholder");
            if (!translations.ar[key]) {
                translations.ar[key] = el.placeholder || "";
            }
        });

        translations.ar.page_title = document.title;
    }

    function applyTranslations(lang) {
        document.querySelectorAll("[data-i18n]").forEach(el => {
            const key = el.getAttribute("data-i18n");
            const value = translations[lang] && translations[lang][key];
            if (!value) return;
            el.innerHTML = value;
        });

        document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
            const key = el.getAttribute("data-i18n-placeholder");
            const value = translations[lang] && translations[lang][key];
            if (!value) return;
            el.placeholder = value;
        });

        if (translations[lang].page_title) {
            document.title = translations[lang].page_title;
        }

        const callStatusEl = document.getElementById("callStatus");
        if (callStatusEl && callStatusEl.dataset.i18n === "status_ready") {
            callStatusEl.innerHTML = translations[lang].status_ready || callStatusEl.innerHTML;
        }
    }

    function applyLanguage(lang) {
        localStorage.setItem("ghasiq_lang", lang);

        if (lang === "en") {
            document.documentElement.setAttribute("dir", "ltr");
            document.documentElement.lang = "en";
            document.getElementById("langLabel").textContent = "EN";
        } else {
            document.documentElement.setAttribute("dir", "rtl");
            document.documentElement.lang = "ar";
            document.getElementById("langLabel").textContent = "AR";
        }

        applyTranslations(lang);
    }

    function initLanguageToggle() {
        initArabicFromDom();

        const saved = localStorage.getItem("ghasiq_lang") || "ar";
        applyLanguage(saved);

        const langToggle = document.getElementById("langToggle");
        if (!langToggle) return;

        langToggle.addEventListener("click", () => {
            const current = localStorage.getItem("ghasiq_lang") || "ar";
            const nextLang = current === "ar" ? "en" : "ar";
            applyLanguage(nextLang);
        });
    }

    initLanguageToggle();
</script>

</body>
</html>
